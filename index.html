<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Farming CBA Decision Aid Tool - Newcastle Business School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body data-theme="worldbank-light">
  <!-- Required global tooltip bubble (used for any element with data-tip) -->
  <div id="tooltipBubble" role="tooltip" aria-hidden="true"></div>

  <!-- Required bottom-right toast host -->
  <div id="toastHost" aria-live="polite" aria-atomic="true"></div>

  <!-- App shell -->
  <div id="appShell">
    <!-- Top navigation -->
    <header id="topNav" class="app-header">
      <div class="brand" id="navBrand">
        <div class="brand-mark" aria-hidden="true">NBS</div>
        <div class="brand-text">
          <div class="brand-title">Farming CBA Decision Aid Tool</div>
          <div class="brand-subtitle">Newcastle Business School</div>
        </div>
      </div>

      <nav class="header-links" aria-label="Primary links">
        <a id="navLinkHome" class="nav-link" href="index.html" data-tip="Open the main tool page.">Home</a>
        <a id="navLinkAppendix" class="nav-link" href="technical-appendix.html" target="_blank" rel="noopener"
           data-tip="Open the technical appendix in a new tab.">
          Technical Appendix
        </a>
      </nav>
    </header>

    <!-- Blocking banner shown when prerequisites are missing -->
    <div id="globalBlockingBanner" class="blocking-banner" role="region" aria-label="Action required" hidden>
      <div class="blocking-inner">
        <div class="blocking-text">
          <strong>Action required:</strong>
          <span id="globalBlockingText">Import and commit data to view results.</span>
        </div>
        <div class="blocking-actions">
          <button id="btnGlobalGoImport" class="btn primary" type="button"
                  data-tip="Go to data import to upload or paste the dataset, then validate and commit.">
            Go to Data Import
          </button>
        </div>
      </div>
    </div>

    <main class="app-main" role="main">
      <!-- Tab bar -->
      <div id="tabBar" class="tabs-nav" role="tablist" aria-label="Main sections">
        <button id="tabBtnResults" type="button" class="tab-link active" role="tab" aria-selected="true"
                aria-controls="tabResults" data-tip="View control versus treatment comparisons and rankings.">
          Results
        </button>
        <button id="tabBtnImport" type="button" class="tab-link" role="tab" aria-selected="false"
                aria-controls="tabImport" data-tip="Upload or paste the dataset and dictionary, then validate and commit.">
          Data Import
        </button>
        <button id="tabBtnConfig" type="button" class="tab-link" role="tab" aria-selected="false"
                aria-controls="tabConfig" data-tip="Set horizon, prices, discount rates, persistence and cost recurrence.">
          Configuration
        </button>
        <button id="tabBtnChecks" type="button" class="tab-link" role="tab" aria-selected="false"
                aria-controls="tabChecks" data-tip="Review scaling rule triggers and data integrity summaries.">
          Data Checks
        </button>
        <button id="tabBtnDiagnostics" type="button" class="tab-link" role="tab" aria-selected="false"
                aria-controls="tabDiagnostics" data-tip="Run diagnostics for missing controls, missing values, and warnings.">
          Diagnostics
        </button>
        <button id="tabBtnAI" type="button" class="tab-link" role="tab" aria-selected="false"
                aria-controls="tabAI" data-tip="Generate a copy-ready briefing prompt and results JSON.">
          AI Briefing
        </button>
        <button id="tabBtnExports" type="button" class="tab-link" role="tab" aria-selected="false"
                aria-controls="tabExports" data-tip="Export cleaned data, summaries, and sensitivity outputs for Excel.">
          Exports
        </button>
        <button id="tabBtnIntro" type="button" class="tab-link" role="tab" aria-selected="false"
                aria-controls="tabIntro" data-tip="Read what the tool does and how to use it.">
          Introduction
        </button>
      </div>

      <!-- Tab panels container -->
      <div id="tabPanels" class="tab-panels">
        <!-- RESULTS TAB (default open) -->
        <section id="tabResults" class="tab-panel active show" role="tabpanel" aria-hidden="false"
                 aria-labelledby="tabBtnResults">
          <div class="card">
            <div class="panel-header">
              <div class="panel-title">
                <h1 class="h2">Comparison to control</h1>
                <p class="small muted" data-tip="This view compares each treatment to the control within each replicate, then applies discounted cost and benefit calculations under the selected scenario.">
                  Select a price, discount rate and persistence pattern, then review the leaderboard and the comparison table.
                </p>
              </div>
              <div class="panel-actions">
                <button id="resBtnRecalc" class="btn primary" type="button"
                        data-tip="Recalculate all results from the committed dataset and the current configuration.">
                  Refresh results
                </button>
              </div>
            </div>

            <!-- Scenario selectors -->
            <div id="resScenarioBar" class="scenario-bar" role="region" aria-label="Scenario selection">
              <div class="field">
                <label for="resSelectPrice" data-tip="Choose the grain price per tonne used to value yield changes.">
                  Grain price (AUD per tonne)
                </label>
                <select id="resSelectPrice"></select>
              </div>

              <div class="field">
                <label for="resSelectDiscount" data-tip="Choose the annual discount rate used for present value calculations.">
                  Discount rate (per year)
                </label>
                <select id="resSelectDiscount"></select>
              </div>

              <div class="field">
                <label for="resSelectPersistence" data-tip="Choose how long yield effects persist over time.">
                  Yield persistence pattern
                </label>
                <select id="resSelectPersistence"></select>
              </div>

              <div id="resViewScale" class="field scale-toggle" role="group" aria-label="View scale">
                <div class="label" data-tip="Switch between per hectare results and scaled totals for farm areas.">
                  View scale
                </div>
                <div class="segmented">
                  <label class="seg">
                    <input id="resScalePerHa" type="radio" name="resScale" value="per_ha" checked />
                    <span>Per hectare</span>
                  </label>
                  <label class="seg">
                    <input id="resScale100ha" type="radio" name="resScale" value="ha_100" />
                    <span>100 hectares</span>
                  </label>
                  <label class="seg">
                    <input id="resScale3300ha" type="radio" name="resScale" value="ha_3300" />
                    <span>3300 hectares</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Quick filters -->
            <div id="resFilterBar" class="filter-bar" role="region" aria-label="Quick filters">
              <div class="filter-group">
                <button id="resFilterAll" type="button" class="btn small"
                        data-tip="Show all treatments that are included in rankings.">
                  Show all
                </button>
                <button id="resFilterTopNPV" type="button" class="btn small"
                        data-tip="Show the top five treatments by net present value under the selected scenario.">
                  Top 5 by net present value
                </button>
                <button id="resFilterTopBCR" type="button" class="btn small"
                        data-tip="Show the top five treatments by benefit cost ratio under the selected scenario.">
                  Top 5 by benefit cost ratio
                </button>
                <button id="resFilterImprove" type="button" class="btn small"
                        data-tip="Show only treatments that improve net present value compared with the control under the selected scenario.">
                  Improvements versus control
                </button>
              </div>
            </div>

            <!-- Notes / warnings -->
            <div id="resNotesCard" class="card subtle" role="region" aria-label="Notes and warnings">
              <div class="card-row">
                <h3 class="h4">Notes</h3>
                <p id="resNotesText" class="small muted">
                  Import and commit data to populate results. If any replicate has no control plots, it will be excluded from incremental calculations and flagged here.
                </p>
              </div>
            </div>

            <!-- Leaderboard -->
            <div id="resLeaderboardWrap" class="leaderboard-wrap" role="region" aria-label="Treatment leaderboard">
              <div class="leaderboard-head">
                <h3 class="h3">Leaderboard</h3>
                <p class="small muted" data-tip="Ranks are computed within the selected scenario slice. Control is shown for context but is not ranked.">
                  One row per treatment with key indicators under the selected scenario.
                </p>
              </div>

              <div class="table-scroll wide">
                <table id="resLeaderboardTable" class="data-table" aria-label="Leaderboard table">
                  <thead>
                    <tr>
                      <th scope="col">Rank</th>
                      <th scope="col">Treatment</th>
                      <th scope="col">Net present value</th>
                      <th scope="col">Net present value (100 hectares)</th>
                      <th scope="col">Net present value (3300 hectares)</th>
                      <th scope="col">Present value of benefits</th>
                      <th scope="col">Present value of costs</th>
                      <th scope="col">Benefit cost ratio</th>
                      <th scope="col">Return on investment</th>
                    </tr>
                  </thead>
                  <tbody id="resLeaderboardTbody"></tbody>
                </table>
              </div>
            </div>

            <!-- Comparison to Control Table -->
            <div id="resComparisonWrap" class="comparison-wrap" role="region" aria-label="Comparison to control table">
              <div class="comparison-head">
                <h3 class="h3">Comparison to control</h3>
                <p class="small muted" data-tip="Rows are indicators. Columns are the control and each treatment. Delta columns show how each treatment differs from the control under the selected scenario.">
                  Scroll sideways to see all treatments. The indicator column and the control column remain pinned.
                </p>
              </div>

              <div class="table-scroll wide comparison-scroll" aria-label="Scrollable comparison table">
                <table id="resComparisonTable" class="data-table comparison-table">
                  <thead id="resComparisonThead"></thead>
                  <tbody id="resComparisonTbody"></tbody>
                </table>
              </div>
            </div>

            <!-- What this means -->
            <div id="resWhatMeansCard" class="card" role="region" aria-label="What this means">
              <h3 class="h3">What this means</h3>
              <p class="small muted" data-tip="This narrative is generated from the computed results under the selected scenario. It is written for farmers and decision makers and avoids technical language in the main interface.">
                Plain language interpretation based on the current scenario.
              </p>
              <div id="resWhatMeansText" class="prose">
                Import and commit data to generate the narrative interpretation.
              </div>
            </div>
          </div>
        </section>

        <!-- DATA IMPORT TAB -->
        <section id="tabImport" class="tab-panel" role="tabpanel" aria-hidden="true" aria-labelledby="tabBtnImport">
          <div class="card">
            <div class="panel-header">
              <div class="panel-title">
                <h2 class="h2">Data import</h2>
                <p class="small muted" data-tip="Upload or paste the full dataset and the full data dictionary. Then validate, preview, and commit. The tool does not drop columns or truncate rows.">
                  Follow the steps: upload or paste, validate, preview, then commit.
                </p>
              </div>
              <div class="panel-actions">
                <button id="impBtnResetAll" class="btn ghost" type="button"
                        data-tip="Reset the tool state and clear any committed data.">
                  Reset tool
                </button>
              </div>
            </div>

            <!-- Step 1: Upload or paste dataset -->
            <div id="impStepUpload" class="step-card" role="region" aria-label="Step 1 upload or paste dataset">
              <div class="step-head">
                <div class="step-num">Step 1</div>
                <div class="step-title">
                  <h3 class="h3">Upload or paste the dataset</h3>
                  <p class="small muted">Accepted formats: tab separated values, comma separated values, or plain text.</p>
                </div>
              </div>

              <div class="row-2">
                <div class="field">
                  <label for="impFileData" data-tip="Upload the full trial dataset as a TSV or CSV file.">
                    Upload dataset file
                  </label>
                  <input id="impFileData" type="file" accept=".tsv,.csv,.txt" />
                  <div class="small muted">
                    The dataset must include plot level observations and replicate identifiers.
                  </div>
                </div>

                <div class="field">
                  <label for="impPasteData" data-tip="Paste the full dataset here. Tabs are preferred. The tool will detect the delimiter.">
                    Paste dataset (tab delimited recommended)
                  </label>
                  <textarea id="impPasteData" class="mono" rows="8" placeholder="Paste the full dataset here."></textarea>
                  <div class="toolbar">
                    <button id="impBtnClearData" type="button" class="btn small"
                            data-tip="Clear the staged dataset text and file selection.">
                      Clear dataset
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step 2: Dictionary -->
            <div id="impStepDict" class="step-card" role="region" aria-label="Step 2 dictionary">
              <div class="step-head">
                <div class="step-num">Step 2</div>
                <div class="step-title">
                  <h3 class="h3">Upload or paste the data dictionary</h3>
                  <p class="small muted">The dictionary drives labels, tooltips, units, and validation messages.</p>
                </div>
              </div>

              <div class="row-2">
                <div class="field">
                  <label for="impFileDict" data-tip="Upload the dictionary CSV file. This is recommended for correct labels and tooltips.">
                    Upload dictionary file (CSV)
                  </label>
                  <input id="impFileDict" type="file" accept=".csv,.txt" />
                  <div class="small muted">
                    If you do not provide a dictionary, the tool can load a minimal scaffold, but labels will be less informative.
                  </div>
                </div>

                <div class="field">
                  <label for="impPasteDict" data-tip="Paste the full dictionary CSV here.">
                    Paste dictionary CSV
                  </label>
                  <textarea id="impPasteDict" class="mono" rows="8" placeholder="Paste the full dictionary CSV here."></textarea>
                  <div class="toolbar">
                    <button id="impBtnClearDict" type="button" class="btn small"
                            data-tip="Clear the staged dictionary text and file selection.">
                      Clear dictionary
                    </button>
                    <button id="impBtnUseSampleDict" type="button" class="btn small ghost"
                            data-tip="Load a minimal dictionary scaffold for required fields only. This does not load any sample data.">
                      Load dictionary scaffold
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step 3: Validate -->
            <div id="impStepValidate" class="step-card" role="region" aria-label="Step 3 validate">
              <div class="step-head">
                <div class="step-num">Step 3</div>
                <div class="step-title">
                  <h3 class="h3">Validate</h3>
                  <p class="small muted">
                    Validation checks missing controls by replicate, missing or non numeric critical fields, and confirms that no unnamed columns exist.
                  </p>
                </div>
              </div>

              <div class="toolbar">
                <button id="impBtnValidate" type="button" class="btn primary"
                        data-tip="Run validation on the staged dataset and dictionary without committing.">
                  Validate
                </button>
                <button id="impBtnCommit" type="button" class="btn"
                        data-tip="Commit the staged dataset and dictionary after validation. Once committed, all tabs update.">
                  Commit dataset
                </button>
              </div>

              <div class="row-2">
                <div class="card subtle">
                  <h4 class="h4">Validation summary</h4>
                  <div id="impValidationSummary" class="small">No validation run yet.</div>
                </div>

                <div class="card subtle">
                  <h4 class="h4">Validation details</h4>
                  <div id="impValidationDetails" class="small muted">
                    Detailed messages will appear here after validation.
                  </div>
                </div>
              </div>

              <div class="row-3">
                <div id="impWarnNoControls" class="banner warning" role="alert" hidden>
                  Some replicates have no control plots. Those replicates will be excluded from incremental calculations.
                </div>
                <div id="impWarnUnnamedCols" class="banner danger" role="alert" hidden>
                  Unnamed columns were detected. Remove unnamed columns before committing.
                </div>
                <div id="impWarnMissingCritical" class="banner warning" role="alert" hidden>
                  Missing or non numeric values were detected in critical fields. The tool treats these as missing and excludes them from averages.
                </div>
              </div>
            </div>

            <!-- Preview -->
            <div id="impPreviewCard" class="card" role="region" aria-label="Preview">
              <h3 class="h3">Preview</h3>
              <div class="row-2">
                <div class="card subtle">
                  <h4 class="h4">Counts</h4>
                  <div id="impPreviewCounts" class="small muted">
                    Rows, columns, replicates and treatments will appear here after parsing.
                  </div>
                </div>
                <div class="card subtle">
                  <h4 class="h4">Key fields</h4>
                  <div id="impPreviewKeyFields" class="small muted">
                    Detected delimiter and key columns will appear here after parsing.
                  </div>
                </div>
              </div>

              <div class="table-scroll wide">
                <table class="data-table" aria-label="Preview first rows">
                  <thead></thead>
                  <tbody id="impPreviewFirstRows"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- CONFIGURATION TAB -->
        <section id="tabConfig" class="tab-panel" role="tabpanel" aria-hidden="true" aria-labelledby="tabBtnConfig">
          <!-- (unchanged content) -->
          <!-- Keep your existing Configuration tab exactly as you pasted it -->
          <div class="card">
            <!-- ... -->
          </div>
        </section>

        <!-- DATA CHECKS TAB -->
        <section id="tabChecks" class="tab-panel" role="tabpanel" aria-hidden="true" aria-labelledby="tabBtnChecks">
          <!-- (unchanged content) -->
          <div class="card">
            <!-- ... -->
          </div>
        </section>

        <!-- DIAGNOSTICS TAB -->
        <section id="tabDiagnostics" class="tab-panel" role="tabpanel" aria-hidden="true" aria-labelledby="tabBtnDiagnostics">
          <!-- (unchanged content) -->
          <div class="card">
            <!-- ... -->
          </div>
        </section>

        <!-- AI BRIEFING TAB -->
        <section id="tabAI" class="tab-panel" role="tabpanel" aria-hidden="true" aria-labelledby="tabBtnAI">
          <!-- (unchanged content) -->
          <div class="card">
            <!-- ... -->
          </div>
        </section>

        <!-- EXPORTS TAB -->
        <section id="tabExports" class="tab-panel" role="tabpanel" aria-hidden="true" aria-labelledby="tabBtnExports">
          <!-- (unchanged content) -->
          <div class="card">
            <!-- ... -->
          </div>
        </section>

        <!-- INTRODUCTION TAB -->
        <section id="tabIntro" class="tab-panel" role="tabpanel" aria-hidden="true" aria-labelledby="tabBtnIntro">
          <!-- (unchanged content) -->
          <div class="card">
            <!-- ... -->
          </div>
        </section>
      </div>
    </main>

    <footer class="app-footer">
      <div class="footer-left">
        <span class="small muted">Farming CBA Decision Aid Tool, Newcastle Business School</span>
      </div>
      <div class="footer-right">
        <a class="small nav-link" href="technical-appendix.html" target="_blank" rel="noopener"
           data-tip="Open the technical appendix in a new tab.">
          Technical Appendix
        </a>
      </div>
    </footer>
  </div>

  <!-- Optional XLSX library for workbook export -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="app.js"></script>

  <!-- Fallback tab switching (works even if app.js fails or is missing handlers) -->
  <script>
    (function () {
      "use strict";

      function byId(id) { return document.getElementById(id); }
      function qsa(sel) { return Array.from(document.querySelectorAll(sel)); }

      function setActiveTab(tabBtnId) {
        var btn = byId(tabBtnId);
        if (!btn) return;

        var panelId = btn.getAttribute("aria-controls");
        if (!panelId) return;

        var allBtns = qsa('#tabBar [role="tab"]');
        var allPanels = qsa('#tabPanels [role="tabpanel"]');

        allBtns.forEach(function (b) {
          var isActive = (b.id === tabBtnId);
          b.classList.toggle("active", isActive);
          b.setAttribute("aria-selected", isActive ? "true" : "false");
          b.tabIndex = isActive ? 0 : -1;
        });

        allPanels.forEach(function (p) {
          var isActive = (p.id === panelId);
          p.classList.toggle("active", isActive);
          p.classList.toggle("show", isActive);
          p.setAttribute("aria-hidden", isActive ? "false" : "true");
        });

        try {
          window.dispatchEvent(new CustomEvent("nbs:tabchange", { detail: { tabButtonId: tabBtnId, panelId: panelId } }));
        } catch (e) {}
      }

      // Bind tab buttons
      qsa('#tabBar [role="tab"]').forEach(function (b) {
        b.addEventListener("click", function () { setActiveTab(b.id); });
        b.addEventListener("keydown", function (e) {
          var keys = ["ArrowLeft", "ArrowRight", "Home", "End"];
          if (keys.indexOf(e.key) === -1) return;

          e.preventDefault();
          var tabs = qsa('#tabBar [role="tab"]');
          var idx = tabs.findIndex(function (t) { return t.id === b.id; });
          if (idx < 0) return;

          var next;
          if (e.key === "Home") next = 0;
          else if (e.key === "End") next = tabs.length - 1;
          else if (e.key === "ArrowLeft") next = (idx - 1 + tabs.length) % tabs.length;
          else next = (idx + 1) % tabs.length;

          tabs[next].focus();
          setActiveTab(tabs[next].id);
        });
      });

      // Wire "Go to..." buttons
      var goImport = byId("btnGlobalGoImport");
      if (goImport) goImport.addEventListener("click", function () { setActiveTab("tabBtnImport"); });

      var introGoImport = byId("btnIntroGoImport");
      if (introGoImport) introGoImport.addEventListener("click", function () { setActiveTab("tabBtnImport"); });

      var introGoResults = byId("btnIntroGoResults");
      if (introGoResults) introGoResults.addEventListener("click", function () { setActiveTab("tabBtnResults"); });

      // Ensure a tab is active on first load
      var active = document.querySelector('#tabBar [role="tab"].active') || byId("tabBtnResults");
      if (active && active.id) setActiveTab(active.id);
    })();
  </script>
</body>
</html>
