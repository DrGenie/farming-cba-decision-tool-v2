<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Farming CBA Decision Tool 2 - Newcastle Business School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body data-theme="worldbank-light">
  <div id="toast-root"></div>

  <header class="app-header">
    <div class="brand">
      <div class="brand-mark">NBS</div>
      <div class="brand-text">
        <div class="brand-title">Farming CBA Decision Tool 2</div>
        <div class="brand-subtitle">Newcastle Business School</div>
      </div>
    </div>
    <div class="header-actions">
      <button id="startBtn" class="btn primary">Start with project setup</button>
      <button id="saveProject" class="btn ghost">Save project (JSON)</button>
      <button id="loadProject" class="btn ghost">Load project</button>
      <input type="file" id="loadFile" accept=".json" style="display:none" />
    </div>
  </header>

  <main class="app-main">
    <nav class="tabs-nav" aria-label="Main sections">
      <button type="button" class="tab-link active" data-tab="intro" aria-selected="true">Introduction</button>
      <button type="button" class="tab-link" data-tab="project">Project</button>
      <button type="button" class="tab-link" data-tab="settings">Time and risk settings</button>
      <button type="button" class="tab-link" data-tab="outputs">Outputs</button>
      <button type="button" class="tab-link" data-tab="treatments">Treatments</button>
      <button type="button" class="tab-link" data-tab="benefits">Additional benefits</button>
      <button type="button" class="tab-link" data-tab="costs">Other costs</button>
      <button type="button" class="tab-link" data-tab="database">Sources</button>
      <button type="button" class="tab-link" data-tab="results">Results</button>
      <button type="button" class="tab-link" data-tab="simulation">Simulation</button>
      <button type="button" class="tab-link" data-tab="excel">Excel import and export</button>
      <button type="button" class="tab-link" data-tab="copilot">AI helper</button>
      <button type="button" class="tab-link" data-tab="appendix">Technical appendix</button>
    </nav>

    <!-- INTRO TAB -->
    <section class="tab-panel active show" id="tab-intro" data-tab-panel="intro" aria-hidden="false">
      <div class="card">
        <h1>Farming CBA Decision Tool 2</h1>
        <p>
          This tool summarises the costs and benefits of farm treatments over a chosen analysis
          period. It is designed for applied farm trials and for rapid assessment of alternative
          strategies.
        </p>
        <p>
          The default scenario is a faba bean soil amendment trial. You can keep this as
          an example or replace it with your own data using the Excel tab.
        </p>
        <p>
          Use the tabs to move from project description, through outputs and treatments, to
          additional benefits, costs, and risk settings. The Results and Simulation tabs provide
          economic indicators and uncertainty analysis.
        </p>
        <div class="intro-actions">
          <button id="startBtn-duplicate" class="btn primary" data-tab-jump="project">
            Go to project setup
          </button>
          <button class="btn" data-tab-jump="outputs">Jump to outputs</button>
          <button class="btn" data-tab-jump="results">Jump to results</button>
        </div>
      </div>
    </section>

    <!-- PROJECT TAB -->
    <section class="tab-panel" id="tab-project" data-tab-panel="project" aria-hidden="true">
      <div class="card">
        <h2>Project description</h2>
        <div class="row-3">
          <div class="field">
            <label for="projectName" data-tooltip="Short title for the farm trial or investment project.">
              Project name
            </label>
            <input id="projectName" type="text" />
          </div>
          <div class="field">
            <label for="projectLead" data-tooltip="Person with overall responsibility for the project.">
              Project lead
            </label>
            <input id="projectLead" type="text" />
          </div>
          <div class="field">
            <label for="analystNames" data-tooltip="People who prepared the cost benefit analysis.">
              Analyst team
            </label>
            <input id="analystNames" type="text" />
          </div>
        </div>

        <div class="row-3">
          <div class="field">
            <label for="projectTeam" data-tooltip="Delivery partners or trial team involved in implementation.">
              Partners or trial team
            </label>
            <input id="projectTeam" type="text" />
          </div>
          <div class="field">
            <label for="organisation" data-tooltip="Host organisation for the analysis or project.">
              Organisation
            </label>
            <input id="organisation" type="text" />
          </div>
          <div class="field">
            <label for="lastUpdated" data-tooltip="Date when the analysis was last updated.">
              Last updated
            </label>
            <input id="lastUpdated" type="date" />
          </div>
        </div>

        <div class="row-3">
          <div class="field">
            <label for="contactEmail" data-tooltip="Contact email for questions about the analysis.">
              Contact email
            </label>
            <input id="contactEmail" type="email" />
          </div>
          <div class="field">
            <label for="contactPhone" data-tooltip="Optional phone contact for follow up.">
              Contact phone
            </label>
            <input id="contactPhone" type="tel" />
          </div>
          <div class="field"></div>
        </div>

        <div class="field">
          <label for="projectSummary" data-tooltip="Short plain language description of the project and trial.">
            Short summary
          </label>
          <textarea id="projectSummary" rows="3"></textarea>
        </div>

        <div class="field">
          <label for="projectGoal" data-tooltip="Main goal in terms of production, profit, or risk reduction.">
            Project goal
          </label>
          <textarea id="projectGoal" rows="2"></textarea>
        </div>

        <div class="row-2">
          <div class="field">
            <label for="withProject" data-tooltip="What happens with the treatments or program in place.">
              With project (change story)
            </label>
            <textarea id="withProject" rows="3"></textarea>
          </div>
          <div class="field">
            <label for="withoutProject" data-tooltip="What happens under business as usual conditions.">
              Without project (baseline story)
            </label>
            <textarea id="withoutProject" rows="3"></textarea>
          </div>
        </div>

        <div class="field">
          <label for="projectObjectives" data-tooltip="Specific measurable objectives for the project.">
            Key objectives
          </label>
          <textarea id="projectObjectives" rows="3"></textarea>
        </div>

        <div class="field">
          <label for="projectActivities" data-tooltip="Main activities that deliver the change (for example extension, training, soil treatments).">
            Main activities
          </label>
          <textarea id="projectActivities" rows="3"></textarea>
        </div>

        <div class="field">
          <label for="stakeholderGroups" data-tooltip="Key stakeholder groups who gain, lose, or are involved.">
            Stakeholder groups
          </label>
          <textarea id="stakeholderGroups" rows="3"></textarea>
        </div>
      </div>
    </section>

    <!-- SETTINGS TAB -->
    <section class="tab-panel" id="tab-settings" data-tab-panel="settings" aria-hidden="true">
      <div class="card">
        <h2>Time horizon and discounting</h2>
        <div class="row-4">
          <div class="field">
            <label for="startYear" data-tooltip="Calendar year when the analysis starts (year 0 cashflows).">
              Analysis start year
            </label>
            <input id="startYear" type="number" />
          </div>
          <div class="field">
            <label for="projectStartYear" data-tooltip="Year when the project or treatments begin on farm.">
              Project start year
            </label>
            <input id="projectStartYear" type="number" />
          </div>
          <div class="field">
            <label for="years" data-tooltip="Number of years over which costs and benefits are counted.">
              Years of analysis
            </label>
            <input id="years" type="number" min="1" />
          </div>
          <div class="field">
            <label for="systemType" data-tooltip="Single farm analysis or roll out across multiple farms.">
              System type
            </label>
            <select id="systemType">
              <option value="single">Single farm or system</option>
              <option value="multiple">Multiple farms or systems</option>
            </select>
          </div>
        </div>

        <div class="row-4">
          <div class="field">
            <label for="discBase" data-tooltip="Central discount rate used for present value calculations.">
              Discount rate (base, percent)
            </label>
            <input id="discBase" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="discLow" data-tooltip="Lower bound for discount rate used in the simulation.">
              Discount rate (low, percent)
            </label>
            <input id="discLow" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="discHigh" data-tooltip="Upper bound for discount rate used in the simulation.">
              Discount rate (high, percent)
            </label>
            <input id="discHigh" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="outputAssumptions" data-tooltip="Any general assumptions about prices, yields, or trial design.">
              Notes on general assumptions
            </label>
            <textarea id="outputAssumptions" rows="2"></textarea>
          </div>
        </div>

        <div class="row-4">
          <div class="field">
            <label for="mirrFinance" data-tooltip="Finance rate used to discount negative cashflows in MIRR.">
              MIRR finance rate (percent)
            </label>
            <input id="mirrFinance" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="mirrReinvest" data-tooltip="Reinvestment rate applied to positive cashflows in MIRR.">
              MIRR reinvestment rate (percent)
            </label>
            <input id="mirrReinvest" type="number" step="0.1" />
          </div>
          <div class="field"></div>
          <div class="field"></div>
        </div>

        <h3>Discount schedule by period</h3>
        <p class="small muted">
          Adjust the low, base, and high discount rates used in the simulation for each period.
        </p>
        <div class="table-scroll">
          <table class="summary-table">
            <thead>
              <tr>
                <th>Period</th>
                <th>Low (percent)</th>
                <th>Base (percent)</th>
                <th>High (percent)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>2025 to 2034</td>
                <td><input type="number" step="0.1" data-disc-period="0" data-scenario="low" /></td>
                <td><input type="number" step="0.1" data-disc-period="0" data-scenario="base" /></td>
                <td><input type="number" step="0.1" data-disc-period="0" data-scenario="high" /></td>
              </tr>
              <tr>
                <td>2035 to 2044</td>
                <td><input type="number" step="0.1" data-disc-period="1" data-scenario="low" /></td>
                <td><input type="number" step="0.1" data-disc-period="1" data-scenario="base" /></td>
                <td><input type="number" step="0.1" data-disc-period="1" data-scenario="high" /></td>
              </tr>
              <tr>
                <td>2045 to 2054</td>
                <td><input type="number" step="0.1" data-disc-period="2" data-scenario="low" /></td>
                <td><input type="number" step="0.1" data-disc-period="2" data-scenario="base" /></td>
                <td><input type="number" step="0.1" data-disc-period="2" data-scenario="high" /></td>
              </tr>
              <tr>
                <td>2055 to 2064</td>
                <td><input type="number" step="0.1" data-disc-period="3" data-scenario="low" /></td>
                <td><input type="number" step="0.1" data-disc-period="3" data-scenario="base" /></td>
                <td><input type="number" step="0.1" data-disc-period="3" data-scenario="high" /></td>
              </tr>
              <tr>
                <td>2065 to 2074</td>
                <td><input type="number" step="0.1" data-disc-period="4" data-scenario="low" /></td>
                <td><input type="number" step="0.1" data-disc-period="4" data-scenario="base" /></td>
                <td><input type="number" step="0.1" data-disc-period="4" data-scenario="high" /></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>Adoption settings</h3>
        <p class="small muted">
          These parameters control the adoption paths used in the results and simulation. Adoption
          by treatment is handled here as a scenario setting rather than in the treatment tab.
        </p>
        <div class="row-3">
          <div class="field">
            <label for="adoptLow" data-tooltip="Lower bound for the share of the target area that adopts the treatment.">
              Adoption low (multiplier)
            </label>
            <input id="adoptLow" type="number" step="0.05" min="0" max="1" />
          </div>
          <div class="field">
            <label for="adoptBase" data-tooltip="Central assumption for the share of the target area that adopts.">
              Adoption base (multiplier)
            </label>
            <input id="adoptBase" type="number" step="0.05" min="0" max="1" />
          </div>
          <div class="field">
            <label for="adoptHigh" data-tooltip="Upper bound for the share of the target area that adopts.">
              Adoption high (multiplier)
            </label>
            <input id="adoptHigh" type="number" step="0.05" min="0" max="1" />
          </div>
        </div>

        <h3>Risk settings</h3>
        <div class="row-3">
          <div class="field">
            <label for="riskLow" data-tooltip="Lower bound for overall risk that benefits are not fully realised.">
              Overall risk low
            </label>
            <input id="riskLow" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="riskBase" data-tooltip="Central estimate of overall risk that reduces effective benefits.">
              Overall risk base
            </label>
            <input id="riskBase" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="riskHigh" data-tooltip="Upper bound for overall risk that reduces effective benefits.">
              Overall risk high
            </label>
            <input id="riskHigh" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>

        <p class="small muted">
          You can also build the base risk from component risks below.
        </p>
        <div class="row-5">
          <div class="field">
            <label for="rTech" data-tooltip="Risk that the technical performance of the treatment is lower than expected.">
              Technical risk
            </label>
            <input id="rTech" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="rNonCoop" data-tooltip="Risk that farmers or partners do not cooperate or maintain practices.">
              Non cooperation risk
            </label>
            <input id="rNonCoop" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="rSocio" data-tooltip="Social or institutional risks that limit implementation.">
              Social risk
            </label>
            <input id="rSocio" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="rFin" data-tooltip="Financial risks such as budget cuts or price changes.">
              Financial risk
            </label>
            <input id="rFin" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="rMan" data-tooltip="Management risks including planning, staffing, and coordination.">
              Management risk
            </label>
            <input id="rMan" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>
        <div class="row-2">
          <div class="field">
            <button id="calcCombinedRisk" class="btn">
              Calculate combined base risk
            </button>
          </div>
          <div class="field">
            <div id="combinedRiskOut" class="metric" data-tooltip="Combined risk derived from the component risks above.">
              <div class="label">Combined risk</div>
              <div class="value small muted">Not calculated yet</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- OUTPUTS TAB -->
    <section class="tab-panel" id="tab-outputs" data-tab-panel="outputs" aria-hidden="true">
      <div class="card">
        <h2>Outputs and valuation</h2>
        <p>
          Outputs describe the main production changes per hectare or per unit. Assign a monetary
          value per unit to link them to benefits. For example, yield multiplied by price per tonne.
        </p>
        <div class="toolbar">
          <button id="addOutput" class="btn small">Add output</button>
        </div>
        <div id="outputsList" class="item-list"></div>
      </div>
    </section>

    <!-- TREATMENTS TAB -->
    <section class="tab-panel" id="tab-treatments" data-tab-panel="treatments" aria-hidden="true">
      <div class="card">
        <h2>Treatments and control</h2>
        <p>
          Each treatment represents a defined practice or combination of practices applied to a
          given area. Use the “Is control” toggle to flag the control. The control is always
          shown alongside treatments in the results table.
        </p>
        <div class="toolbar">
          <button id="addTreatment" class="btn small">Add treatment</button>
        </div>
        <div id="treatmentsList" class="item-list"></div>
      </div>
    </section>

    <!-- BENEFITS TAB -->
    <section class="tab-panel" id="tab-benefits" data-tab-panel="benefits" aria-hidden="true">
      <div class="card">
        <h2>Additional benefits</h2>
        <p>
          Use this section for cost savings, avoided losses, risk reduction, and asset value
          changes that are not already captured in the treatment outputs.
        </p>
        <div class="toolbar">
          <button id="addBenefit" class="btn small">Add benefit</button>
        </div>
        <div id="benefitsList" class="item-list"></div>
      </div>
    </section>

    <!-- COSTS TAB -->
    <section class="tab-panel" id="tab-costs" data-tab-panel="costs" aria-hidden="true">
      <div class="card">
        <h2>Other project costs</h2>
        <p>
          Enter project management, monitoring, extension, or other aggregated costs here. Capital
          items can include depreciation information. Depreciation settings only apply to items in
          the capital category. Labour costs at treatment level are handled in the Treatments tab.
        </p>
        <div class="toolbar">
          <button id="addCost" class="btn small">Add cost item</button>
        </div>
        <div id="costsList" class="item-list"></div>
      </div>
    </section>

    <!-- DATABASE TAB -->
    <section class="tab-panel" id="tab-database" data-tab-panel="database" aria-hidden="true">
      <div class="card">
        <h2>Sources and database tagging</h2>
        <p class="small muted">
          Use this tab to record data sources that can later be linked to a shared database or
          evidence register.
        </p>

        <h3>Outputs</h3>
        <div id="dbOutputs" class="item-list"></div>

        <h3>Treatments</h3>
        <div id="dbTreatments" class="item-list"></div>
      </div>
    </section>

    <!-- RESULTS TAB -->
    <section class="tab-panel" id="tab-results" data-tab-panel="results" aria-hidden="true">
      <div class="card">
        <div class="results-header">
          <h2>Economic results</h2>
          <button id="recalc" class="btn primary" data-action="recalc">
            Recalculate results
          </button>
        </div>

        <h3>Snapshot: control and treatment comparison</h3>
        <p class="small muted">
          Treatments are compared against the control in a single table. Economic indicators are
          shown as rows and treatments as columns so that figures align vertically for easy
          comparison.
        </p>
        <div class="table-scroll">
          <table id="treatmentMatrix" class="summary-table sticky-header">
            <thead>
              <tr id="treatmentMatrixHead">
                <!-- Filled by script -->
              </tr>
            </thead>
            <tbody id="treatmentMatrixBody">
              <!-- Filled by script -->
            </tbody>
          </table>
        </div>

        <div class="results-footer compact">
          <button id="exportExcelMatrix" class="btn">
            Export results table to Excel
          </button>
          <button id="exportCsv" class="btn ghost">Export CSV (all treatments)</button>
          <button id="exportPdf" class="btn ghost">Print or export PDF</button>
        </div>

        <hr />

        <h3>Whole project summary (base case)</h3>
        <div class="row-4 metrics-grid">
          <div class="field">
            <label>
              <span class="with-tooltip" data-tooltip="Present value of all benefits across the analysis period using the base discount rate.">
                Present value of benefits
              </span>
            </label>
            <div class="metric">
              <div id="pvBenefits" class="value">0</div>
              <div class="label">All benefits, discounted</div>
            </div>
          </div>
          <div class="field">
            <label>
              <span class="with-tooltip" data-tooltip="Present value of all costs across the analysis period using the base discount rate.">
                Present value of costs
              </span>
            </label>
            <div class="metric">
              <div id="pvCosts" class="value">0</div>
              <div class="label">All costs, discounted</div>
            </div>
          </div>
          <div class="field">
            <label>
              <span class="with-tooltip" data-tooltip="Present value of benefits minus present value of costs for the whole project.">
                Net present value
              </span>
            </label>
            <div class="metric">
              <div id="npv" class="value">0</div>
              <div class="label">Benefits minus costs</div>
            </div>
          </div>
          <div class="field">
            <label>
              <span class="with-tooltip" data-tooltip="Present value of benefits divided by present value of costs. Values greater than 1 indicate that benefits exceed costs.">
                Benefit–cost ratio
              </span>
            </label>
            <div class="metric">
              <div id="bcr" class="value">0</div>
              <div class="label">PV benefits divided by PV costs</div>
            </div>
          </div>
        </div>

        <div class="row-4 metrics-grid">
          <div class="field">
            <label>
              <span class="with-tooltip" data-tooltip="Discount rate at which the net present value is equal to zero.">
                Internal rate of return
              </span>
            </label>
            <div class="metric">
              <div id="irr" class="value">0</div>
              <div class="label">Percent return solving NPV equal to zero</div>
            </div>
          </div>
          <div class="field">
            <label>
              <span class="with-tooltip" data-tooltip="Rate of return calculated using separate finance and reinvestment rates.">
                Modified internal rate of return
              </span>
            </label>
            <div class="metric">
              <div id="mirr" class="value">0</div>
              <div class="label">Uses finance and reinvestment rates</div>
            </div>
          </div>
          <div class="field">
            <label>
              <span class="with-tooltip" data-tooltip="Net present value expressed as a percentage of the present value of costs.">
                Return on investment
              </span>
            </label>
            <div class="metric">
              <div id="roi" class="value">0</div>
              <div class="label">NPV relative to PV of costs</div>
            </div>
          </div>
          <div class="field">
            <label>
              <span class="with-tooltip" data-tooltip="Number of years for the discounted net benefits to first turn positive.">
                Payback period
              </span>
            </label>
            <div class="metric">
              <div id="payback" class="value">0</div>
              <div class="label">Discounted time to recover costs</div>
            </div>
          </div>
        </div>

        <div class="row-2 metrics-grid">
          <div class="field">
            <label>
              <span class="with-tooltip" data-tooltip="Average annual benefits minus annual costs across the analysis period.">
                Annual gross margin
              </span>
            </label>
            <div class="metric">
              <div id="grossMargin" class="value">0</div>
              <div class="label">Average annual benefits minus costs</div>
            </div>
          </div>
          <div class="field">
            <label>
              <span class="with-tooltip" data-tooltip="Annual gross margin divided by annual benefits, expressed as a percentage.">
                Gross profit margin
              </span>
            </label>
            <div class="metric">
              <div id="profitMargin" class="value">0</div>
              <div class="label">Gross margin as a share of benefits</div>
            </div>
          </div>
        </div>

        <hr />

        <h3>Ranking of treatments</h3>
        <p class="small muted" data-tooltip="Treatments are ordered from highest to lowest benefit–cost ratio using the base case assumptions. Low-performing treatments are retained for learning and improvement.">
          Treatments are ranked by benefit–cost ratio using the current base case assumptions. All
          treatments remain visible, including low-performing options.
        </p>
        <div id="treatmentSummary" class="item-list"></div>

        <hr />

        <h3>Net present value by analysis horizon</h3>
        <div class="row-2">
          <div class="field">
            <div class="table-scroll">
              <table id="timeProjectionTable" class="summary-table">
                <thead>
                  <tr>
                    <th data-tooltip="Number of years included in the partial analysis.">Years</th>
                    <th data-tooltip="Present value of benefits for the given analysis horizon.">PV benefits</th>
                    <th data-tooltip="Present value of costs for the given analysis horizon.">PV costs</th>
                    <th data-tooltip="Net present value for the given analysis horizon.">NPV</th>
                    <th data-tooltip="Benefit–cost ratio for the given analysis horizon.">BCR</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="field">
            <canvas id="timeNpvChart" width="480" height="260" data-tooltip="Line chart of net present value against analysis horizon."></canvas>
          </div>
        </div>

        <hr />

        <h3>Depreciation summary for capital items</h3>
        <div id="depSummary"></div>
      </div>
    </section>

    <!-- SIMULATION TAB -->
    <section class="tab-panel" id="tab-simulation" data-tab-panel="simulation" aria-hidden="true">
      <div class="card">
        <div class="results-header">
          <h2>Monte Carlo simulation</h2>
          <button id="runSim" class="btn primary" data-action="run-sim">
            Run simulation
          </button>
        </div>

        <p class="small muted">
          The simulation varies discount rates, adoption, risk, and optional cost and benefit
          inputs within the ranges set in the Settings tab. This allows you to see how sensitive
          the results are to key assumptions.
        </p>

        <div class="row-4">
          <div class="field">
            <label for="simN" data-tooltip="Number of random draws used in the Monte Carlo simulation. Larger values give smoother results but take longer.">
              Number of runs
            </label>
            <input id="simN" type="number" min="100" step="100" />
          </div>
          <div class="field">
            <label for="targetBCR" data-tooltip="Benefit–cost ratio threshold used to define a successful outcome.">
              Target BCR for success
            </label>
            <input id="targetBCR" type="number" step="0.1" min="0" />
            <div class="small muted">
              Current target: <span id="simBcrTargetLabel">2</span>
            </div>
          </div>
          <div class="field">
            <label for="bcrMode" data-tooltip="Choice of whether the benefit–cost ratio divides by all costs or only constrained costs.">
              BCR denominator
            </label>
            <select id="bcrMode">
              <option value="all">All costs</option>
              <option value="constrained">Constrained costs only</option>
            </select>
          </div>
          <div class="field">
            <label for="randSeed" data-tooltip="Optional random seed to reproduce the same simulation results. Leave blank for a different draw each time.">
              Random seed (optional)
            </label>
            <input id="randSeed" type="number" />
          </div>
        </div>

        <h3>Variation settings</h3>
        <div class="row-4">
          <div class="field">
            <label for="simVarPct" data-tooltip="Size of the random variation applied to selected inputs, expressed as a percentage.">
              Variation size (percent)
            </label>
            <input id="simVarPct" type="number" step="1" min="0" max="100" />
          </div>
          <div class="field">
            <label for="simVaryOutputs" data-tooltip="If yes, output prices or values are randomly varied within the chosen range.">
              Vary output values
            </label>
            <select id="simVaryOutputs">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="field">
            <label for="simVaryTreatCosts" data-tooltip="If yes, treatment level costs are randomly varied within the chosen range.">
              Vary treatment costs
            </label>
            <select id="simVaryTreatCosts">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="field">
            <label for="simVaryInputCosts" data-tooltip="If yes, other project costs (for example management) are randomly varied within the chosen range.">
              Vary other project costs
            </label>
            <select id="simVaryInputCosts">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
        </div>

        <div class="field">
          <div id="simStatus" class="small muted">Simulation not run yet.</div>
        </div>

        <hr />

        <h3>Simulation summary</h3>
        <div class="row-2">
          <div class="card subtle">
            <h4>Net present value</h4>
            <div class="row-4 metrics-grid">
              <div class="field">
                <label data-tooltip="Minimum simulated net present value across all runs.">
                  Minimum
                </label>
                <div class="metric"><div id="simNpvMin" class="value">n/a</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Maximum simulated net present value across all runs.">
                  Maximum
                </label>
                <div class="metric"><div id="simNpvMax" class="value">n/a</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Average net present value across all simulation runs.">
                  Mean
                </label>
                <div class="metric"><div id="simNpvMean" class="value">n/a</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Median net present value across all simulation runs.">
                  Median
                </label>
                <div class="metric"><div id="simNpvMedian" class="value">n/a</div></div>
              </div>
            </div>
            <div class="row-2 metrics-grid">
              <div class="field">
                <label data-tooltip="Share of simulation runs where net present value is greater than zero.">
                  Probability NPV &gt; 0
                </label>
                <div class="metric"><div id="simNpvProb" class="value">n/a</div></div>
              </div>
            </div>
          </div>

          <div class="card subtle">
            <h4>Benefit–cost ratio</h4>
            <div class="row-4 metrics-grid">
              <div class="field">
                <label data-tooltip="Minimum simulated benefit–cost ratio across all runs.">
                  Minimum
                </label>
                <div class="metric"><div id="simBcrMin" class="value">n/a</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Maximum simulated benefit–cost ratio across all runs.">
                  Maximum
                </label>
                <div class="metric"><div id="simBcrMax" class="value">n/a</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Average benefit–cost ratio across all simulation runs.">
                  Mean
                </label>
                <div class="metric"><div id="simBcrMean" class="value">n/a</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Median benefit–cost ratio across all simulation runs.">
                  Median
                </label>
                <div class="metric"><div id="simBcrMedian" class="value">n/a</div></div>
              </div>
            </div>
            <div class="row-3 metrics-grid">
              <div class="field">
                <label data-tooltip="Share of simulation runs where the benefit–cost ratio is greater than 1.">
                  Probability BCR &gt; 1
                </label>
                <div class="metric"><div id="simBcrProb1" class="value">n/a</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Share of simulation runs where the benefit–cost ratio exceeds the target value.">
                  Probability BCR &gt; target
                </label>
                <div class="metric"><div id="simBcrProbTarget" class="value">n/a</div></div>
              </div>
              <div class="field"></div>
            </div>
          </div>
        </div>

        <hr />

        <h3>Distributions</h3>
        <div class="row-2">
          <div class="field">
            <canvas id="histNpv" width="480" height="260" data-tooltip="Histogram of simulated net present value."></canvas>
          </div>
          <div class="field">
            <canvas id="histBcr" width="480" height="260" data-tooltip="Histogram of simulated benefit–cost ratio."></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- EXCEL TAB -->
    <section class="tab-panel" id="tab-excel" data-tab-panel="excel" aria-hidden="true">
      <div class="card">
        <h2>Excel import and export</h2>
        <p>
          You can export a template or a sample workbook, populate it in Excel, and import it back
          into the tool. The sample workbook includes the faba bean raw data sheet so that
          the trial can be reproduced and extended.
        </p>

        <div class="row-2">
          <div class="field">
            <h3>Templates</h3>
            <button id="downloadTemplate" class="btn">Download blank template</button>
            <button id="downloadSample" class="btn ghost">
              Download sample based on current scenario
            </button>
          </div>
          <div class="field">
            <h3>Import from Excel</h3>
            <p class="small muted">
              First parse the workbook, then apply the parsed data once you are
              satisfied that the structure is read correctly. The tool looks for a
              “Treatments” sheet and an optional faba bean raw data sheet and updates
              the scenario automatically.
            </p>
            <button id="parseExcel" class="btn">Parse Excel file</button>
            <button id="importExcel" class="btn ghost">
              Apply parsed Excel data to the model
            </button>
            <div id="excelStatus" class="small muted">No Excel file parsed yet.</div>
          </div>
        </div>

        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display:none" />

        <p class="small muted">
          Excel import and export features rely on the SheetJS XLSX library loaded in the page. If
          the library is not present, the tool will prompt you.
        </p>
      </div>
    </section>

    <!-- COPILOT / AI HELPER TAB -->
    <section class="tab-panel" id="tab-copilot" data-tab-panel="copilot" aria-hidden="true">
      <div class="card">
        <h2>AI helper for interpretation and policy briefs</h2>
        <p>
          This tab prepares a structured summary that can be copied into a separate AI assistant
          (for example Copilot or ChatGPT) to draft a plain language interpretation or policy brief.
          The content reflects the current settings and results from the Farming CBA Decision Tool 2.
        </p>
        <div class="row-2">
          <div class="field">
            <button id="openCopilot" class="btn primary">
              Copy AI prompt for interpretation
            </button>
            <p class="small muted">
              Clicking this button copies a structured scenario description and instructions to your
              clipboard. Paste it into your preferred assistant and ask for a plain-English
              interpretation or a two to three page policy brief. The prompt is designed to support
              decision making without telling you what to do.
            </p>
            <label for="policyBriefText" class="small muted">
              Optional: paste the AI-generated policy brief here if you want to keep it with the project.
            </label>
            <textarea id="policyBriefText" rows="10"></textarea>
            <button id="downloadBrief" class="btn small">
              Download policy brief as text file
            </button>
          </div>
          <div class="field">
            <label for="copilotPreview" data-tooltip="Structured JSON-style request that is copied when you click the button.">
              Preview of AI prompt payload
            </label>
            <textarea id="copilotPreview" rows="18" readonly class="mono"></textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- TECHNICAL APPENDIX TAB -->
    <section class="tab-panel" id="tab-appendix" data-tab-panel="appendix" aria-hidden="true">
      <div class="card">
        <h2>Technical appendix and user guide</h2>
        <p>
          The technical appendix provides a full description of the example dataset,
          formulas for all indicators, and step-by-step guidance for both non-technical and
          technical audiences.
        </p>
        <div class="row-2">
          <div class="field">
            <button
              type="button"
              class="btn primary"
              onclick="window.open('technical-appendix.html','_blank','noopener');"
            >
              Open full technical appendix
            </button>
            <p class="small muted">
              This opens the appendix in a separate browser tab or window so you can read the
              details while keeping your scenario open here.
            </p>
          </div>
          <div class="field">
            <label class="small muted">
              If the button does not work in your browser you can also use this link.
            </label>
            <a href="technical-appendix.html" target="_blank" rel="noopener" class="small">
              Open technical-appendix.html in a new tab
            </a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <div class="footer-left">
      <span class="small muted">Farming CBA Decision Tool 2, Newcastle Business School</span>
    </div>
    <div class="footer-right">
      <button id="exportCsvFoot" class="btn small">Export CSV</button>
      <button id="exportPdfFoot" class="btn small ghost">Print or PDF</button>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="app.js"></script>
</body>
</html>
