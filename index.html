<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Farming CBA Decision Aid</title>
  <link rel="stylesheet" href="./styles.css" />
  <!-- SheetJS (XLSX) for client-side Excel import -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="./app.js"></script>
</head>
<body>
  <header class="app-header">
    <div class="app-header__left">
      <div class="brand">
        <div class="brand__mark" aria-hidden="true">F</div>
        <div class="brand__text">
          <div class="brand__title">Farming CBA Decision Aid</div>
          <div class="brand__subtitle">Import trial data, compare amendments, run simple gross margin scenarios</div>
        </div>
      </div>
    </div>

    <div class="app-header__right">
      <div class="pill" id="datasetPill" title="Dataset status">No data loaded</div>
      <button class="btn btn--ghost" id="btnReset" type="button" title="Reset to initial state">Reset</button>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Tool sections">
    <button class="tab is-active" role="tab" aria-selected="true" aria-controls="panel-import" id="tab-import" data-tab="import" type="button">Import</button>
    <button class="tab" role="tab" aria-selected="false" aria-controls="panel-treatments" id="tab-treatments" data-tab="treatments" type="button">Treatments</button>
    <button class="tab" role="tab" aria-selected="false" aria-controls="panel-scenarios" id="tab-scenarios" data-tab="scenarios" type="button">Scenario</button>
    <button class="tab" role="tab" aria-selected="false" aria-controls="panel-outputs" id="tab-outputs" data-tab="outputs" type="button">Export</button>
    <button class="tab" role="tab" aria-selected="false" aria-controls="panel-help" id="tab-help" data-tab="help" type="button">Help</button>
  </nav>

  <main class="main">
    <!-- Import -->
    <section class="panel is-active" role="tabpanel" id="panel-import" aria-labelledby="tab-import" data-panel="import">
      <div class="grid grid--2">
        <div class="card">
          <div class="card__header">
            <h2 class="card__title">Import Excel</h2>
            <div class="card__subtitle">Choose an .xlsx file. The tool will auto-detect the header row and key fields.</div>
          </div>

          <div class="card__body">
            <div class="stack">
              <div class="row">
                <label class="label" for="fileInput">Excel file (.xlsx)</label>
                <input id="fileInput" class="file" type="file" accept=".xlsx,.xls" />
              </div>

              <div class="row row--wrap">
                <button class="btn" id="btnLoadBundledXlsx" type="button">Load bundled XLSX (if present)</button>
                <button class="btn btn--secondary" id="btnLoadEmbedded" type="button">Load embedded Lockhart sample</button>
              </div>

              <div class="callout" id="importCallout">
                <div class="callout__title">Tip</div>
                <div class="callout__text">
                  If you want the page to auto-load your uploaded file when hosted, place the Excel in the same folder as these files and name it <code>data.xlsx</code>.
                  The “Load bundled XLSX” button tries <code>./data.xlsx</code> first, then <code>./Data for Lockhart-FA-031225 (1).xlsx</code>.
                </div>
              </div>

              <div class="divider"></div>

              <div class="kpi-grid">
                <div class="kpi">
                  <div class="kpi__label">Rows</div>
                  <div class="kpi__value" id="kpiRows">0</div>
                </div>
                <div class="kpi">
                  <div class="kpi__label">Treatments</div>
                  <div class="kpi__value" id="kpiTreatments">0</div>
                </div>
                <div class="kpi">
                  <div class="kpi__label">Yield field</div>
                  <div class="kpi__value kpi__value--mono" id="kpiYieldKey">—</div>
                </div>
                <div class="kpi">
                  <div class="kpi__label">Cost field</div>
                  <div class="kpi__value kpi__value--mono" id="kpiCostKey">—</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card__header">
            <h2 class="card__title">Data preview</h2>
            <div class="card__subtitle">First rows from the imported sheet.</div>
          </div>
          <div class="card__body">
            <div class="muted" id="previewNote">No data yet. Import an Excel file or load the embedded sample.</div>
            <div class="table-wrap" id="previewTableWrap" hidden></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="card__header">
          <h2 class="card__title">Detected columns</h2>
          <div class="card__subtitle">Useful when your workbook has duplicated or messy headers.</div>
        </div>
        <div class="card__body">
          <div class="chips" id="columnsChips"></div>
        </div>
      </div>
    </section>

    <!-- Treatments -->
    <section class="panel" role="tabpanel" id="panel-treatments" aria-labelledby="tab-treatments" data-panel="treatments">
      <div class="card">
        <div class="card__header">
          <h2 class="card__title">Treatment comparison</h2>
          <div class="card__subtitle">Means by treatment (default grouping uses <code>Amendment</code>, then falls back to <code>Trt</code>).</div>
        </div>

        <div class="card__body">
          <div class="toolbar">
            <div class="toolbar__group">
              <label class="label" for="baselineSelect">Baseline</label>
              <select id="baselineSelect" class="select"></select>
            </div>

            <div class="toolbar__group">
              <label class="label" for="sortSelect">Sort</label>
              <select id="sortSelect" class="select">
                <option value="delta_gm_desc">Incremental gross margin (desc)</option>
                <option value="gm_desc">Gross margin (desc)</option>
                <option value="yield_desc">Yield (desc)</option>
                <option value="cost_asc">Cost (asc)</option>
                <option value="name_asc">Name (A→Z)</option>
              </select>
            </div>

            <div class="toolbar__group toolbar__group--wide">
              <label class="label" for="searchInput">Search</label>
              <input id="searchInput" class="input" type="text" placeholder="Filter treatments…" />
            </div>

            <div class="toolbar__spacer"></div>

            <div class="toolbar__group">
              <button class="btn btn--secondary" id="btnToScenario" type="button">Adjust scenario</button>
            </div>
          </div>

          <div class="table-wrap" id="treatmentsTableWrap"></div>

          <div class="note" id="treatmentsNote">
            Gross margin = Yield × Price − Total cost. Incremental gross margin is computed relative to the chosen baseline using group means.
          </div>
        </div>
      </div>
    </section>

    <!-- Scenario -->
    <section class="panel" role="tabpanel" id="panel-scenarios" aria-labelledby="tab-scenarios" data-panel="scenarios">
      <div class="grid grid--2">
        <div class="card">
          <div class="card__header">
            <h2 class="card__title">Scenario settings</h2>
            <div class="card__subtitle">Applies instantly to the treatment table and exports.</div>
          </div>

          <div class="card__body">
            <div class="form-grid">
              <div class="row">
                <label class="label" for="priceInput">Grain price ($/t)</label>
                <input class="input" id="priceInput" type="number" min="0" step="1" />
                <div class="hint">Used with the detected yield field (t/ha) to compute revenue per hectare.</div>
              </div>

              <div class="row">
                <label class="label" for="yieldScaleInput">Yield scale</label>
                <select class="select" id="yieldScaleInput">
                  <option value="1">Use as-is</option>
                  <option value="0.1">× 0.1</option>
                  <option value="10">× 10</option>
                </select>
                <div class="hint">If your yield column is recorded in different units.</div>
              </div>

              <div class="row">
                <label class="label" for="costScaleInput">Cost scale</label>
                <select class="select" id="costScaleInput">
                  <option value="1">Use as-is</option>
                  <option value="0.01">× 0.01</option>
                  <option value="100">× 100</option>
                </select>
                <div class="hint">If your cost column is recorded in cents or other scaling.</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row row--wrap">
              <button class="btn" id="btnBackToTreatments" type="button">Back to treatments</button>
              <button class="btn btn--ghost" id="btnResetScenario" type="button">Reset scenario defaults</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card__header">
            <h2 class="card__title">Sanity checks</h2>
            <div class="card__subtitle">Quick diagnostics to avoid silent parsing mistakes.</div>
          </div>
          <div class="card__body">
            <div class="sanity" id="sanityBox">
              <div class="muted">Load data to see diagnostics.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Export -->
    <section class="panel" role="tabpanel" id="panel-outputs" aria-labelledby="tab-outputs" data-panel="outputs">
      <div class="card">
        <div class="card__header">
          <h2 class="card__title">Export</h2>
          <div class="card__subtitle">Download processed data and summaries for reporting.</div>
        </div>

        <div class="card__body">
          <div class="row row--wrap">
            <button class="btn" id="btnExportProcessedCsv" type="button">Download processed rows (CSV)</button>
            <button class="btn btn--secondary" id="btnExportSummaryCsv" type="button">Download treatment summary (CSV)</button>
            <button class="btn btn--ghost" id="btnExportJson" type="button">Download state (JSON)</button>
          </div>

          <div class="divider"></div>

          <div class="muted" id="exportNote">
            Exports use the current scenario (price and scaling). If nothing downloads, check your browser’s pop-up/download permissions.
          </div>
        </div>
      </div>
    </section>

    <!-- Help -->
    <section class="panel" role="tabpanel" id="panel-help" aria-labelledby="tab-help" data-panel="help">
      <div class="card">
        <div class="card__header">
          <h2 class="card__title">Help</h2>
          <div class="card__subtitle">How the tool reads your workbook and what to do if detection is off.</div>
        </div>
        <div class="card__body">
          <div class="prose">
            <p>
              This tool imports the first worksheet in your Excel file, finds the densest row among the first 60 rows (the likely header row),
              deduplicates repeated header names, and reads subsequent rows until the sheet becomes mostly empty.
            </p>
            <p>
              The treatment grouping key is chosen by preference: <code>Amendment</code>, then <code>Treatment</code>/<code>Trt</code>, then the first non-empty text column.
              Yield is detected by matching headers like <code>Yield</code> (prefer <code>Yield t/ha</code>), and total cost by preference for a header named <code>|</code>,
              otherwise the numeric “cost-like” column with the strongest coverage.
            </p>
            <p>
              If your workbook uses different names, the detected keys will show on the Import tab. If yield or cost looks wrong, use the scaling controls in the Scenario tab
              (for unit mismatches) or adjust your Excel headers and re-import.
            </p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true" hidden>
    <div class="toast__content" id="toastText"></div>
  </div>
</body>
</html>
