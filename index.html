<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farming CBA Decision Tool 2</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="styles.css" />
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <a class="skiplink" href="#mainContent">Skip to content</a>

  <header class="topbar">
    <div class="topbar__inner">
      <div class="brand">
        <div class="brand__mark" aria-hidden="true">WB</div>
        <div class="brand__text">
          <div class="brand__title">Farming CBA Decision Tool 2</div>
          <div class="brand__sub">Cost–benefit comparison of treatments against a control, with exports and policy brief pack</div>
        </div>
      </div>

      <div class="topbar__actions">
        <label class="fileBtn" for="fileInput" data-tooltip="Upload the Excel dataset used for analysis.">
          <span class="fileBtn__icon" aria-hidden="true">⬆</span>
          <span class="fileBtn__text">Upload Excel</span>
        </label>
        <input id="fileInput" type="file" accept=".xlsx,.xls" />
      </div>
    </div>

    <div class="topbar__status">
      <div id="statusBox" class="status" hidden></div>
    </div>
  </header>

  <div class="shell">
    <nav class="tabs" aria-label="Primary navigation">
      <div class="tabs__inner" role="tablist" data-tablist>
        <button role="tab" class="tab is-active" aria-selected="true" aria-controls="tab-intro" data-default="true">
          Introduction
        </button>
        <button role="tab" class="tab" aria-selected="false" aria-controls="tab-data" tabindex="-1">
          Data
        </button>
        <button role="tab" class="tab" aria-selected="false" aria-controls="tab-assumptions" tabindex="-1">
          Assumptions
        </button>
        <button role="tab" class="tab" aria-selected="false" aria-controls="tab-benefits" tabindex="-1">
          Additional benefits
        </button>
        <button role="tab" class="tab" aria-selected="false" aria-controls="tab-costs" tabindex="-1">
          Additional costs
        </button>
        <button role="tab" class="tab" aria-selected="false" aria-controls="tab-results" tabindex="-1">
          Results
        </button>
        <button role="tab" class="tab" aria-selected="false" aria-controls="tab-sim" tabindex="-1">
          Simulations
        </button>
        <button role="tab" class="tab" aria-selected="false" aria-controls="tab-copilot" tabindex="-1">
          Copilot / AI brief
        </button>
        <button role="tab" class="tab" aria-selected="false" aria-controls="tab-export" tabindex="-1">
          Export
        </button>
      </div>
    </nav>

    <main id="mainContent" class="content" tabindex="-1">

      <!-- INTRO -->
      <section id="tab-intro" role="tabpanel" class="panel is-active">
        <div class="panelHeader">
          <h1>Introduction</h1>
          <p class="lede">
            This tool helps compare a control alongside multiple treatments using consistent cost–benefit metrics over a chosen time horizon.
            It is designed to be readable for farmers, policy makers, and researchers.
          </p>
        </div>

        <div class="grid2">
          <div class="card">
            <h2 class="h2">What the indicators mean</h2>
            <div class="prose">
              <p><span class="term" data-tooltip="Discounted sum of benefits over the chosen horizon.">PV Benefits</span> is the discounted value of benefits over time. In this tool, benefits are driven mainly by yield (t/ha) multiplied by grain price ($/t), scaled to the farm area.</p>
              <p><span class="term" data-tooltip="Discounted sum of costs over the chosen horizon.">PV Costs</span> is the discounted value of costs over time. Costs come from the dataset’s cost columns (typically $/ha) scaled to the farm area, plus any user-added items.</p>
              <p><span class="term" data-tooltip="PV Benefits minus PV Costs.">NPV</span> is the net value after costs. A higher NPV indicates a stronger net economic outcome under the current assumptions.</p>
              <p><span class="term" data-tooltip="PV Benefits divided by PV Costs.">BCR</span> compares discounted benefits to discounted costs. Values above 1 indicate benefits exceed costs in present value terms.</p>
              <p><span class="term" data-tooltip="NPV divided by PV Costs.">ROI</span> describes net gain per dollar of PV cost.</p>
            </div>
          </div>

          <div class="card">
            <h2 class="h2">Workflow</h2>
            <ol class="steps">
              <li><strong>Upload</strong> the Excel dataset.</li>
              <li>Check the <strong>Data</strong> tab for detected fields (treatment, yield, costs).</li>
              <li>Set <strong>Assumptions</strong> (area, horizon, discount rate, grain price).</li>
              <li>Add <strong>Additional benefits/costs</strong> if needed.</li>
              <li>Review <strong>Results</strong> and <strong>Simulations</strong> for uncertainty.</li>
              <li>Use <strong>Export</strong> and <strong>Copilot / AI brief</strong> for reporting.</li>
            </ol>
            <div class="callout mt12">
              <div class="callout__title">Decision support</div>
              <div class="callout__body">The tool is designed to clarify trade-offs, not to impose thresholds or rules. Results change when assumptions change.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- DATA -->
      <section id="tab-data" role="tabpanel" class="panel" hidden>
        <div class="panelHeader">
          <h1>Data</h1>
          <p class="lede">Upload the Excel file. The tool auto-detects treatment, yield, and cost fields and previews the dataset.</p>
        </div>

        <div class="grid2">
          <div class="card">
            <h2 class="h2">Sheet selection</h2>
            <div class="row">
              <label class="label" for="sheetSelect">Worksheet</label>
              <select id="sheetSelect" class="select" disabled></select>
            </div>
            <div id="dataSummary" class="mt12"></div>
          </div>

          <div class="card">
            <h2 class="h2">Preview</h2>
            <div id="dataPreview"></div>
          </div>
        </div>
      </section>

      <!-- ASSUMPTIONS -->
      <section id="tab-assumptions" role="tabpanel" class="panel" hidden>
        <div class="panelHeader">
          <h1>Assumptions</h1>
          <p class="lede">These settings drive the present value calculations and the treatment comparisons.</p>
        </div>

        <div class="grid2">
          <div class="card">
            <h2 class="h2">Core settings</h2>

            <div class="formGrid">
              <div class="field">
                <label class="label" for="areaHa">Farm area (hectares)</label>
                <input id="areaHa" class="input" type="number" min="0" step="1" value="100" />
              </div>

              <div class="field">
                <label class="label" for="horizonYears">Time horizon (years)</label>
                <input id="horizonYears" class="input" type="number" min="1" max="60" step="1" value="10" />
              </div>

              <div class="field">
                <label class="label" for="discountRate">Discount rate (% per year)</label>
                <input id="discountRate" class="input" type="number" min="0" max="50" step="0.1" value="7" />
              </div>

              <div class="field">
                <label class="label" for="grainPrice">Grain price ($ per tonne)</label>
                <input id="grainPrice" class="input" type="number" min="0" step="1" value="450" />
              </div>
            </div>

            <div class="callout mt12">
              <div class="callout__title">Tip</div>
              <div class="callout__body">If the dataset contains yield (t/ha) and costs ($/ha), the tool converts those to annual farm totals using the area setting.</div>
            </div>

            <div class="actions mt12">
              <button id="runAnalysisBtn" class="btn btn--primary">Run analysis</button>
            </div>
          </div>

          <div class="card">
            <h2 class="h2">Optional trends</h2>
            <p class="muted">Use these only if you want to represent gradual changes over time.</p>

            <div class="formGrid">
              <div class="field">
                <label class="label" for="priceGrowth">Price growth (% per year)</label>
                <input id="priceGrowth" class="input" type="number" step="0.1" value="0" />
              </div>
              <div class="field">
                <label class="label" for="yieldGrowth">Yield growth (% per year)</label>
                <input id="yieldGrowth" class="input" type="number" step="0.1" value="0" />
              </div>
              <div class="field">
                <label class="label" for="costGrowth">Cost growth (% per year)</label>
                <input id="costGrowth" class="input" type="number" step="0.1" value="0" />
              </div>
            </div>

            <div class="prose mt12">
              <p class="muted">If you keep these at zero, the tool assumes steady annual benefits and costs across the horizon.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- ADDITIONAL BENEFITS -->
      <section id="tab-benefits" role="tabpanel" class="panel" hidden>
        <div class="panelHeader">
          <h1>Additional benefits</h1>
          <p class="lede">Add benefits not already captured by yield × price (for example, improved soil condition benefits, avoided losses, co-benefits).</p>
        </div>

        <div class="grid2">
          <div class="card">
            <h2 class="h2">Add a benefit item</h2>

            <div class="formGrid">
              <div class="field">
                <label class="label" for="benName">Name</label>
                <input id="benName" class="input" type="text" placeholder="e.g., reduced erosion damage" />
              </div>

              <div class="field">
                <label class="label" for="benValue">Value ($)</label>
                <input id="benValue" class="input" type="number" step="1" placeholder="e.g., 15000" />
              </div>

              <div class="field">
                <label class="label" for="benUnit">Unit</label>
                <select id="benUnit" class="select">
                  <option value="per_ha">per ha</option>
                  <option value="total">total (whole farm)</option>
                </select>
              </div>

              <div class="field">
                <label class="label" for="benMode">Frequency</label>
                <select id="benMode" class="select">
                  <option value="annual">annual</option>
                  <option value="oneoff">one-off</option>
                </select>
              </div>

              <div class="field">
                <label class="label" for="benStart">Start year</label>
                <input id="benStart" class="input" type="number" min="1" step="1" value="1" />
              </div>

              <div class="field">
                <label class="label" for="benEnd">End year</label>
                <input id="benEnd" class="input" type="number" min="1" step="1" value="10" />
              </div>
            </div>

            <div class="actions mt12">
              <button id="addBenefitBtn" class="btn btn--primary">Add benefit</button>
            </div>
          </div>

          <div class="card">
            <h2 class="h2">Current additional benefits</h2>
            <div id="addBenefitsList" class="list"></div>
          </div>
        </div>
      </section>

      <!-- ADDITIONAL COSTS -->
      <section id="tab-costs" role="tabpanel" class="panel" hidden>
        <div class="panelHeader">
          <h1>Additional costs</h1>
          <p class="lede">Add costs not already captured in the dataset (for example, transition costs, compliance costs, monitoring, capital outlays).</p>
        </div>

        <div class="grid2">
          <div class="card">
            <h2 class="h2">Add a cost item</h2>

            <div class="formGrid">
              <div class="field">
                <label class="label" for="costName">Name</label>
                <input id="costName" class="input" type="text" placeholder="e.g., upfront equipment upgrade" />
              </div>

              <div class="field">
                <label class="label" for="costValue">Value ($)</label>
                <input id="costValue" class="input" type="number" step="1" placeholder="e.g., 25000" />
              </div>

              <div class="field">
                <label class="label" for="costUnit">Unit</label>
                <select id="costUnit" class="select">
                  <option value="per_ha">per ha</option>
                  <option value="total">total (whole farm)</option>
                </select>
              </div>

              <div class="field">
                <label class="label" for="costMode">Frequency</label>
                <select id="costMode" class="select">
                  <option value="annual">annual</option>
                  <option value="oneoff">one-off</option>
                </select>
              </div>

              <div class="field">
                <label class="label" for="costStart">Start year</label>
                <input id="costStart" class="input" type="number" min="1" step="1" value="1" />
              </div>

              <div class="field">
                <label class="label" for="costEnd">End year</label>
                <input id="costEnd" class="input" type="number" min="1" step="1" value="10" />
              </div>
            </div>

            <div class="actions mt12">
              <button id="addCostBtn" class="btn btn--primary">Add cost</button>
            </div>
          </div>

          <div class="card">
            <h2 class="h2">Current additional costs</h2>
            <div id="addCostsList" class="list"></div>
          </div>
        </div>
      </section>

      <!-- RESULTS -->
      <section id="tab-results" role="tabpanel" class="panel" hidden>
        <div class="panelHeader">
          <h1>Results</h1>
          <p class="lede">Indicators are rows and treatments are columns. The control is shown alongside all treatments for direct comparison.</p>
        </div>

        <div id="resultsCallout" class="mb12"></div>

        <div class="card">
          <h2 class="h2">Core results</h2>
          <div id="resultsTable"></div>
        </div>

        <div class="card mt12">
          <h2 class="h2">Differences versus control</h2>
          <div id="resultsDeltaTable"></div>
        </div>
      </section>

      <!-- SIMULATIONS -->
      <section id="tab-sim" role="tabpanel" class="panel" hidden>
        <div class="panelHeader">
          <h1>Simulations</h1>
          <p class="lede">Explore uncertainty by allowing price, yield, and costs to vary randomly around the base values.</p>
        </div>

        <div class="grid2">
          <div class="card">
            <h2 class="h2">Settings</h2>

            <div class="formGrid">
              <div class="field">
                <label class="label" for="simDraws">Number of draws</label>
                <input id="simDraws" class="input" type="number" min="200" step="100" value="2000" />
              </div>
              <div class="field">
                <label class="label" for="simPriceSD">Price uncertainty (SD as proportion)</label>
                <input id="simPriceSD" class="input" type="number" min="0" step="0.05" value="0.20" />
              </div>
              <div class="field">
                <label class="label" for="simYieldSD">Yield uncertainty (SD as proportion)</label>
                <input id="simYieldSD" class="input" type="number" min="0" step="0.05" value="0.15" />
              </div>
              <div class="field">
                <label class="label" for="simCostSD">Cost uncertainty (SD as proportion)</label>
                <input id="simCostSD" class="input" type="number" min="0" step="0.05" value="0.15" />
              </div>
            </div>

            <div class="actions mt12">
              <button id="runSimBtn" class="btn btn--primary">Run simulations</button>
            </div>

            <div class="mt12">
              <label class="label" for="simTreatmentSelect">Histogram treatment</label>
              <select id="simTreatmentSelect" class="select"></select>
            </div>

            <div id="simSummary" class="mt12"></div>
          </div>

          <div class="card">
            <h2 class="h2">NPV histogram</h2>
            <div class="chartWrap">
              <canvas id="simChart" class="chart"></canvas>
            </div>
            <div class="muted mt8">Histogram shows a representative sample of simulated NPVs for the selected treatment.</div>

            <div class="mt12">
              <h3 class="h3">Simulation summary table</h3>
              <div id="simTable"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- COPILOT -->
      <section id="tab-copilot" role="tabpanel" class="panel" hidden>
        <div class="panelHeader">
          <h1>Copilot / AI brief</h1>
          <p class="lede">Generate a structured prompt, JSON data, and Word-ready tables to produce a full policy brief using your AI tool.</p>
        </div>

        <div id="copilotBox" class="mb12"></div>

        <div class="grid2">
          <div class="card">
            <h2 class="h2">Prompt</h2>
            <textarea id="copilotPrompt" class="textarea" rows="14" spellcheck="false"></textarea>
            <div class="actions mt12">
              <button id="copyPromptBtn" class="btn btn--primary">Copy prompt</button>
            </div>
          </div>

          <div class="card">
            <h2 class="h2">JSON (paste after the prompt)</h2>
            <textarea id="copilotJSON" class="textarea" rows="14" spellcheck="false"></textarea>
            <div class="actions mt12">
              <button id="copyJSONBtn" class="btn btn--primary">Copy JSON</button>
            </div>
          </div>
        </div>

        <div class="card mt12">
          <h2 class="h2">Word-ready tables (Markdown)</h2>
          <textarea id="copilotMD" class="textarea" rows="14" spellcheck="false"></textarea>
          <div class="actions mt12">
            <button id="copyMDBtn" class="btn btn--primary">Copy tables</button>
          </div>
        </div>
      </section>

      <!-- EXPORT -->
      <section id="tab-export" role="tabpanel" class="panel" hidden>
        <div class="panelHeader">
          <h1>Export</h1>
          <p class="lede">Export results for reporting and downstream analysis.</p>
        </div>

        <div class="grid2">
          <div class="card">
            <h2 class="h2">Excel export</h2>
            <p class="muted">Downloads a clean workbook with Summary, Results, Deltas, Additional items, and the Copilot pack.</p>
            <div class="actions mt12">
              <button id="exportExcelBtn" class="btn btn--primary">Download Excel</button>
            </div>
          </div>

          <div class="card">
            <h2 class="h2">CSV export</h2>
            <p class="muted">Downloads Results and Deltas (two sections) as a single CSV file.</p>
            <div class="actions mt12">
              <button id="exportCSVBtn" class="btn">Download CSV</button>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <footer class="footer">
    <div class="footer__inner">
      <div class="muted">Farming CBA Decision Tool 2 · Decision support tool for transparent comparisons against a control.</div>
    </div>
  </footer>

  <script src="app.js"></script>
</body>
</html>
