<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Farming CBA Decision Tool 2</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./styles.css" />

  <!-- SheetJS (XLSX) -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="./app.js"></script>
</head>

<body>
  <a class="skip-link" href="#main">Skip to main content</a>

  <header class="topbar">
    <div class="topbar__inner">
      <div class="brand">
        <div class="brand__mark" aria-hidden="true">F</div>
        <div class="brand__text">
          <div class="brand__title">Farming CBA Decision Tool 2</div>
          <div class="brand__subtitle">Compare treatments against a control, run scenarios, export results</div>
        </div>
      </div>

      <div class="topbar__actions">
        <button id="btnDownloadResults" class="btn btn--primary" type="button" title="Download a results workbook (Excel)">
          Download results (Excel)
        </button>
        <button id="btnCopyResults" class="btn btn--ghost" type="button" title="Copy results table for Word">
          Copy results table
        </button>
      </div>
    </div>
  </header>

  <main id="main" class="page">
    <section class="card card--hero">
      <div class="hero">
        <div class="hero__left">
          <h1 class="hero__h1">Upload your farm trial or scenario spreadsheet</h1>
          <p class="hero__p">
            This tool reads your uploaded Excel file, identifies treatments (including the control), calculates annual cashflows,
            then reports NPV, PV benefits, PV costs, BCR, ROI, and ranking. You can add extra benefits and costs, and run simulations.
          </p>

          <div class="uploader">
            <label class="uploader__label" for="fileInput">
              Upload Excel (.xlsx)
              <span class="hint" title="Your file stays in your browser; nothing is uploaded to a server.">ⓘ</span>
            </label>
            <div class="uploader__row">
              <input id="fileInput" class="uploader__input" type="file" accept=".xlsx,.xls" />
              <button id="btnUseDemo" class="btn btn--outline" type="button" title="Load the last uploaded file again after changes">
                Recalculate
              </button>
            </div>
            <div class="uploader__meta" id="fileMeta" aria-live="polite"></div>
          </div>
        </div>

        <div class="hero__right">
          <div class="status">
            <div class="status__item">
              <div class="status__label">Data status</div>
              <div class="status__value" id="statusData">No file loaded</div>
            </div>
            <div class="status__item">
              <div class="status__label">Detected format</div>
              <div class="status__value" id="statusFormat">—</div>
            </div>
            <div class="status__item">
              <div class="status__label">Treatments</div>
              <div class="status__value" id="statusTreatments">—</div>
            </div>
          </div>

          <div class="callouts">
            <div class="callout">
              <div class="callout__title">For farmers</div>
              <div class="callout__text">Plain-language explanations and “what drives results” guidance.</div>
            </div>
            <div class="callout">
              <div class="callout__title">For policy and research</div>
              <div class="callout__text">Transparent assumptions, exports, and simulation-based uncertainty.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="tabs" role="tablist" aria-label="Tool sections">
        <button class="tab is-active" role="tab" aria-selected="true" aria-controls="tabIntro" id="tIntro" data-tab="tabIntro" type="button">Introduction</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="tabData" id="tData" data-tab="tabData" type="button">Data</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="tabAssumptions" id="tAssumptions" data-tab="tabAssumptions" type="button">Assumptions</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="tabBenefits" id="tBenefits" data-tab="tabBenefits" type="button">Additional benefits</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="tabCosts" id="tCosts" data-tab="tabCosts" type="button">Additional costs</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="tabResults" id="tResults" data-tab="tabResults" type="button">Results</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="tabSim" id="tSim" data-tab="tabSim" type="button">Simulations</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="tabCopilot" id="tCopilot" data-tab="tabCopilot" type="button">Co-pilot / AI brief</button>
      </div>

      <div class="tabpanes">
        <!-- INTRO -->
        <section id="tabIntro" class="tabpane is-active" role="tabpanel" tabindex="0" aria-labelledby="tIntro">
          <div class="pane">
            <div class="pane__grid">
              <div class="pane__col">
                <h2>What the numbers mean (in practical terms)</h2>
                <div class="explain">
                  <div class="explain__row">
                    <div class="explain__term">PV benefits</div>
                    <div class="explain__def">The value today of all expected benefits (like extra grain income) over the time horizon, after discounting.</div>
                  </div>
                  <div class="explain__row">
                    <div class="explain__term">PV costs</div>
                    <div class="explain__def">The value today of all costs (upfront and ongoing) over the time horizon, after discounting.</div>
                  </div>
                  <div class="explain__row">
                    <div class="explain__term">NPV</div>
                    <div class="explain__def">PV benefits minus PV costs. Positive means net gain in today’s dollars.</div>
                  </div>
                  <div class="explain__row">
                    <div class="explain__term">BCR</div>
                    <div class="explain__def">PV benefits divided by PV costs. Higher means more benefit per dollar of cost (interpret alongside NPV).</div>
                  </div>
                  <div class="explain__row">
                    <div class="explain__term">ROI</div>
                    <div class="explain__def">NPV divided by PV costs. Interpretable as net gain per dollar of PV cost.</div>
                  </div>
                </div>

                <div class="note">
                  <div class="note__title">Control comparison</div>
                  <div class="note__text">
                    The results table always includes the control alongside all treatments, so you can compare both absolute values and differences.
                  </div>
                </div>
              </div>

              <div class="pane__col">
                <h2>Typical improvement levers (options, not rules)</h2>
                <div class="cards">
                  <div class="mini">
                    <div class="mini__title">Increase benefits</div>
                    <div class="mini__text">Higher yields, better grain prices, improved quality premiums, better adoption, reduced losses.</div>
                  </div>
                  <div class="mini">
                    <div class="mini__title">Reduce costs</div>
                    <div class="mini__text">Lower input rates, cheaper product sourcing, better timing, reduced passes, equipment sharing.</div>
                  </div>
                  <div class="mini">
                    <div class="mini__title">Change timing</div>
                    <div class="mini__text">Upfront costs vs ongoing costs, ramp-up of benefits, and persistence/decay of effects.</div>
                  </div>
                </div>

                <div class="divider"></div>

                <h2>How to use</h2>
                <ol class="steps">
                  <li>Upload your Excel file.</li>
                  <li>Confirm the control treatment and check assumptions.</li>
                  <li>Add any extra benefits or costs you want included.</li>
                  <li>Review results and export to Excel or copy into Word.</li>
                  <li>Use simulations to see uncertainty and downside risk.</li>
                </ol>
              </div>
            </div>
          </div>
        </section>

        <!-- DATA -->
        <section id="tabData" class="tabpane" role="tabpanel" tabindex="0" aria-labelledby="tData">
          <div class="pane">
            <div class="pane__top">
              <h2>Data snapshot</h2>
              <div class="pane__actions">
                <button id="btnDetectControl" class="btn btn--outline" type="button" title="Automatically pick a control treatment if present">
                  Auto-detect control
                </button>
              </div>
            </div>

            <div class="grid2">
              <div class="field">
                <label for="controlSelect">Control treatment</label>
                <select id="controlSelect"></select>
                <div class="field__help">Used as the baseline comparator for treatment differences.</div>
              </div>

              <div class="field">
                <label for="treatmentCount">Treatments detected</label>
                <input id="treatmentCount" type="text" readonly />
                <div class="field__help">From your file (grouped by treatment label).</div>
              </div>
            </div>

            <div class="divider"></div>

            <h3>Detected columns (and how they are used)</h3>
            <div class="tablewrap">
              <table class="table" id="detectedTable">
                <thead>
                  <tr>
                    <th>Role</th>
                    <th>Column</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="divider"></div>

            <h3>Treatment summary (from uploaded data)</h3>
            <div class="tablewrap">
              <table class="table" id="treatmentSummaryTable">
                <thead>
                  <tr>
                    <th>Treatment</th>
                    <th>n</th>
                    <th>Mean yield (t/ha)</th>
                    <th>SD yield</th>
                    <th>Mean cost (per ha)</th>
                    <th>SD cost</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="muted">
              If your sheet has missing costs for some treatments, you can add them in “Additional costs” (or override in Assumptions).
            </div>
          </div>
        </section>

        <!-- ASSUMPTIONS -->
        <section id="tabAssumptions" class="tabpane" role="tabpanel" tabindex="0" aria-labelledby="tAssumptions">
          <div class="pane">
            <div class="pane__top">
              <h2>Scenario assumptions</h2>
              <div class="pane__actions">
                <button id="btnApplyAssumptions" class="btn btn--primary" type="button">Apply & Recalculate</button>
              </div>
            </div>

            <div class="grid3">
              <div class="field">
                <label for="areaHa">Farm area (hectares) <span class="hint" title="Used to scale per-hectare values to whole-farm totals.">ⓘ</span></label>
                <input id="areaHa" type="number" min="0" step="1" value="100" />
              </div>

              <div class="field">
                <label for="horizonY">Time horizon (years) <span class="hint" title="How many years benefits/costs are counted.">ⓘ</span></label>
                <input id="horizonY" type="number" min="1" step="1" value="10" />
              </div>

              <div class="field">
                <label for="discountRate">Discount rate (% per year) <span class="hint" title="Used to convert future values into today’s value (PV).">ⓘ</span></label>
                <input id="discountRate" type="number" min="0" step="0.1" value="7" />
              </div>

              <div class="field">
                <label for="grainPrice">Grain price ($/t) <span class="hint" title="Applied to yield differences to estimate income changes.">ⓘ</span></label>
                <input id="grainPrice" type="number" min="0" step="1" value="450" />
              </div>

              <div class="field">
                <label for="benefitPersistence">Benefit persistence <span class="hint" title="How treatment yield effects change over time.">ⓘ</span></label>
                <select id="benefitPersistence">
                  <option value="flat">Flat (same each year)</option>
                  <option value="linearDecay">Linear decay to 0 by end</option>
                  <option value="expDecay">Exponential decay</option>
                  <option value="rampUp">Ramp up then flat</option>
                </select>
              </div>

              <div class="field">
                <label for="decayParam">Persistence parameter <span class="hint" title="Used for exponential decay or ramp-up strength (higher = faster change).">ⓘ</span></label>
                <input id="decayParam" type="number" min="0" step="0.1" value="1.5" />
              </div>
            </div>

            <div class="divider"></div>

            <h3>Cost timing from uploaded data</h3>
            <div class="grid2">
              <div class="field">
                <label for="baseCostTiming">Treatment cost timing <span class="hint" title="How to apply the uploaded “cost per ha” values across years.">ⓘ</span></label>
                <select id="baseCostTiming">
                  <option value="upfront">Upfront (Year 1 only)</option>
                  <option value="annual">Annual (repeat each year)</option>
                  <option value="amortise">Amortise evenly across years</option>
                </select>
              </div>

              <div class="field">
                <label for="costInflation">Cost inflation (%/year) <span class="hint" title="Optional escalation for costs over time.">ⓘ</span></label>
                <input id="costInflation" type="number" min="-50" step="0.1" value="0" />
              </div>
            </div>

            <div class="divider"></div>

            <h3>Overrides (optional)</h3>
            <div class="grid2">
              <div class="field">
                <label for="overrideYieldCol">Yield column override</label>
                <select id="overrideYieldCol"></select>
                <div class="field__help">If the detected yield column is wrong, pick another numeric column.</div>
              </div>

              <div class="field">
                <label for="overrideCostCol">Cost column override</label>
                <select id="overrideCostCol"></select>
                <div class="field__help">If the detected cost column is missing/wrong, pick another numeric column (per ha).</div>
              </div>
            </div>
          </div>
        </section>

        <!-- ADDITIONAL BENEFITS -->
        <section id="tabBenefits" class="tabpane" role="tabpanel" tabindex="0" aria-labelledby="tBenefits">
          <div class="pane">
            <div class="pane__top">
              <h2>Additional benefits</h2>
              <div class="pane__actions">
                <button id="btnAddBenefit" class="btn btn--primary" type="button">Add benefit</button>
              </div>
            </div>

            <p class="muted">
              Use this for benefits not captured by yield (for example, quality premiums, reduced risk costs you wish to value, soil improvements with a monetised estimate).
              You can apply to all treatments or a specific treatment.
            </p>

            <div class="tablewrap">
              <table class="table" id="benefitsTable">
                <thead>
                  <tr>
                    <th>Applies to</th>
                    <th>Name</th>
                    <th>Amount ($/ha/year)</th>
                    <th>Start year</th>
                    <th>End year</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ADDITIONAL COSTS -->
        <section id="tabCosts" class="tabpane" role="tabpanel" tabindex="0" aria-labelledby="tCosts">
          <div class="pane">
            <div class="pane__top">
              <h2>Additional costs</h2>
              <div class="pane__actions">
                <button id="btnAddCost" class="btn btn--primary" type="button">Add cost</button>
              </div>
            </div>

            <p class="muted">
              Use this for costs not in the uploaded sheet or where you need to correct missing values (for example, contractor costs, monitoring, compliance, transaction costs).
            </p>

            <div class="tablewrap">
              <table class="table" id="costsTable">
                <thead>
                  <tr>
                    <th>Applies to</th>
                    <th>Name</th>
                    <th>Amount ($/ha)</th>
                    <th>Type</th>
                    <th>Year(s)</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- RESULTS -->
        <section id="tabResults" class="tabpane" role="tabpanel" tabindex="0" aria-labelledby="tResults">
          <div class="pane">
            <div class="pane__top">
              <h2>Results (control shown alongside all treatments)</h2>
              <div class="pane__actions">
                <button id="btnRecalcResults" class="btn btn--primary" type="button">Recalculate</button>
              </div>
            </div>

            <div class="tablewrap">
              <table class="table table--sticky" id="resultsTable">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="divider"></div>

            <h3>What drives the ranking (plain-language notes)</h3>
            <div id="driverNotes" class="notes"></div>

            <div class="divider"></div>

            <h3>Cashflow preview (per ha, by year)</h3>
            <div class="grid2">
              <div class="field">
                <label for="cashflowTreatment">Select treatment</label>
                <select id="cashflowTreatment"></select>
              </div>
              <div class="field">
                <label for="cashflowMode">View</label>
                <select id="cashflowMode">
                  <option value="perHa">Per ha</option>
                  <option value="wholeFarm">Whole farm</option>
                </select>
              </div>
            </div>

            <div class="tablewrap">
              <table class="table" id="cashflowTable">
                <thead>
                  <tr>
                    <th>Year</th>
                    <th>Benefits</th>
                    <th>Costs</th>
                    <th>Net</th>
                    <th>Discount factor</th>
                    <th>PV(Net)</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- SIMULATIONS -->
        <section id="tabSim" class="tabpane" role="tabpanel" tabindex="0" aria-labelledby="tSim">
          <div class="pane">
            <div class="pane__top">
              <h2>Simulations (uncertainty and downside risk)</h2>
              <div class="pane__actions">
                <button id="btnRunSim" class="btn btn--primary" type="button">Run simulations</button>
              </div>
            </div>

            <div class="grid3">
              <div class="field">
                <label for="simN">Iterations</label>
                <input id="simN" type="number" min="200" step="100" value="2000" />
              </div>
              <div class="field">
                <label for="simPriceSD">Price uncertainty (SD, %)</label>
                <input id="simPriceSD" type="number" min="0" step="0.1" value="10" />
              </div>
              <div class="field">
                <label for="simYieldSDMode">Yield SD source</label>
                <select id="simYieldSDMode">
                  <option value="fromData">From data (treatment SD)</option>
                  <option value="pooled">Pooled SD across treatments</option>
                  <option value="fixed">Fixed % of mean</option>
                </select>
              </div>
              <div class="field">
                <label for="simFixedYieldPct">Fixed yield SD (% of mean)</label>
                <input id="simFixedYieldPct" type="number" min="0" step="0.1" value="8" />
              </div>
              <div class="field">
                <label for="simCostSDPct">Cost uncertainty (SD, %)</label>
                <input id="simCostSDPct" type="number" min="0" step="0.1" value="5" />
              </div>
              <div class="field">
                <label for="simTreatment">Treatment</label>
                <select id="simTreatment"></select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="tablewrap">
              <table class="table" id="simTable">
                <thead>
                  <tr>
                    <th>Metric</th>
                    <th>Value</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="muted">
              Simulations use simple normal draws around yield and costs. Use this as decision support, not as a guarantee.
            </div>
          </div>
        </section>

        <!-- COPILOT -->
        <section id="tabCopilot" class="tabpane" role="tabpanel" tabindex="0" aria-labelledby="tCopilot">
          <div class="pane">
            <div class="pane__top">
              <h2>Co-pilot / AI brief builder</h2>
              <div class="pane__actions">
                <button id="btnBuildBrief" class="btn btn--primary" type="button">Build briefing prompt</button>
                <button id="btnCopyBrief" class="btn btn--ghost" type="button">Copy prompt</button>
              </div>
            </div>

            <p class="muted">
              This generates a structured prompt with your assumptions, results table, and plain-language driver notes.
              Paste it into your preferred AI assistant to draft a full policy brief and publication-ready tables.
            </p>

            <textarea id="briefBox" class="textbox" rows="18" spellcheck="false"></textarea>

            <div class="note">
              <div class="note__title">Suggested outputs to request</div>
              <div class="note__text">
                Ask for a 2–5 page brief with an executive summary, scenario assumptions, results table, interpretation against control,
                uncertainty notes, and a short section on implementation considerations.
              </div>
            </div>
          </div>
        </section>
      </div>
    </section>

    <footer class="footer">
      <div class="footer__inner">
        <div class="footer__left">Decision support only. Always validate assumptions and data.</div>
        <div class="footer__right" id="lastCalc"></div>
      </div>
    </footer>

    <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>
  </main>
</body>
</html>
