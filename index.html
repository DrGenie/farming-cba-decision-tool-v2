<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Farming CBA Decision Tool 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <!-- XLSX for Excel/CSV import & export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title-block">
        <h1>Farming CBA Decision Tool 2</h1>
        <p class="app-subtitle">
          Snapshot-first, Excel-first cost–benefit analysis using the Lockhart field trial dataset.
        </p>
      </div>
      <div class="app-badge">CBA</div>
    </header>

    <nav class="tabs">
      <button class="tab-button active" data-tab="tab-intro">1. Overview</button>
      <button class="tab-button" data-tab="tab-data">2. Data &amp; Treatments</button>
      <button class="tab-button" data-tab="tab-results">3. Results matrix</button>
      <button class="tab-button" data-tab="tab-ai">4. AI helper prompt</button>
      <button class="tab-button" data-tab="tab-export">5. Export &amp; print</button>
    </nav>

    <main class="tab-container">
      <!-- TAB 1: INTRO -->
      <section id="tab-intro" class="tab-pane active">
        <div class="card">
          <h2>How this tool works</h2>
          <p>
            This tool turns your Lockhart field trial dataset into a simple cost–benefit analysis,
            comparing each soil amendment against the control. It is designed for an Excel-first
            workflow: you upload the original dataset (no reformatting), the tool aggregates by
            amendment, and the results matrix shows NPV, PV benefits, PV costs, BCR, ROI and ranking.
          </p>

          <p>
            The workflow is:
          </p>
          <ol class="steps-list">
            <li><strong>Data &amp; Treatments:</strong> Upload the Lockhart data file
              (<code>.xlsx</code> or <code>.csv</code>) exactly as provided. The tool automatically
              finds the header row (<em>Amendment</em>, <em>Yield t/ha</em>,
              <em>Treatment Input Cost Only /Ha</em>) and aggregates over all plots.</li>
            <li><strong>Results matrix:</strong> Set the grain price, discount rate and time horizon.
              The tool computes PV benefits, PV costs, NPV, BCR and ROI per treatment, all per hectare
              and relative to the control.</li>
            <li><strong>AI helper:</strong> Copy a ready-made prompt (with JSON summary of the results)
              into your preferred AI assistant for a farmer-friendly interpretation.</li>
            <li><strong>Export &amp; print:</strong> Export the results matrix to Excel or print a clean
              results page to PDF via the browser print dialog.</li>
          </ol>

          <div class="info-callout">
            <h3>What the tool assumes</h3>
            <p>
              For each treatment, the tool:
            </p>
            <ul>
              <li>Aggregates all plots with the same <strong>Amendment</strong> label.</li>
              <li>Uses the average <strong>Yield t/ha</strong> as the treatment yield.</li>
              <li>Uses the average <strong>Treatment Input Cost Only /Ha</strong> as the yearly
                  treatment cost per hectare.</li>
              <li>Treats the control as the baseline. PV benefits are the discounted value of extra
                  yield revenue versus the control. PV costs are the discounted treatment costs plus
                  any capital cost you specify.</li>
            </ul>
            <p>
              You can override yields, costs and control choice in the <strong>Data &amp; Treatments</strong>
              tab if you want to test alternative scenarios.
            </p>
          </div>
        </div>
      </section>

      <!-- TAB 2: DATA & TREATMENTS -->
      <section id="tab-data" class="tab-pane">
        <div class="card">
          <h2>Step 1: Upload Lockhart data</h2>
          <p>
            Upload the original Lockhart field trial dataset
            (<code>.xlsx</code> or <code>.csv</code>) exactly as it is. The tool will automatically
            locate the header row and read:
            <strong>Amendment</strong>, <strong>Yield t/ha</strong>, and
            <strong>Treatment Input Cost Only /Ha</strong>.
          </p>

          <div class="upload-row">
            <label for="file-input" class="upload-label">
              Data file (Lockhart field trial)
            </label>
            <input
              id="file-input"
              type="file"
              accept=".xlsx,.xls,.csv"
            />
          </div>
          <p id="file-status" class="text-muted">
            No file loaded yet. Please upload the Lockhart dataset.
          </p>

          <hr class="section-divider" />

          <h2>Step 2: Check and adjust treatments</h2>
          <p>
            Once the file is loaded, the table below shows one row per amendment (treatment),
            with average yield and cost per hectare. You can edit these values or add a capital
            cost per hectare in year 0 to stress-test different scenarios. One treatment is
            marked as the <strong>control</strong>; by default this is any amendment whose name
            contains “control”, otherwise the first treatment in the list.
          </p>

          <p id="treatments-no-data" class="text-muted">
            Treatments will appear here after you load the dataset.
          </p>

          <div class="table-wrapper">
            <table class="data-table" id="treatments-table">
              <thead>
                <tr>
                  <th>Treatment (Amendment)</th>
                  <th>Yield (t/ha)</th>
                  <th>Capital cost ($/ha, year 0)</th>
                  <th>Annual treatment cost ($/ha)</th>
                  <th>Control?</th>
                </tr>
              </thead>
              <tbody id="treatments-table-body">
                <!-- Filled by app.js -->
              </tbody>
            </table>
          </div>

          <p class="text-muted">
            Any changes here immediately update the CBA results in the next tab.
          </p>
        </div>
      </section>

      <!-- TAB 3: RESULTS -->
      <section id="tab-results" class="tab-pane">
        <div class="card">
          <h2>Step 3: Results matrix</h2>

          <div class="results-config-grid">
            <div class="field-group">
              <label for="price-per-tonne">Grain price ($ per tonne)</label>
              <input
                id="price-per-tonne"
                type="number"
                step="1"
                min="0"
                value="600"
              />
            </div>

            <div class="field-group">
              <label for="discount-rate">Discount rate (% per year)</label>
              <input
                id="discount-rate"
                type="number"
                step="0.1"
                min="0"
                max="100"
                value="7"
              />
            </div>

            <div class="field-group">
              <label for="time-horizon">Time horizon (years)</label>
              <input
                id="time-horizon"
                type="number"
                step="1"
                min="1"
                value="10"
              />
            </div>
          </div>

          <p class="results-summary" id="scenario-summary">
            Price per tonne: <span id="summary-price">600</span>,
            discount rate: <span id="summary-discount">7</span>%,
            time horizon: <span id="summary-horizon">10</span> years.
          </p>

          <p id="results-empty" class="text-muted">
            Upload the Lockhart dataset in the <strong>Data &amp; Treatments</strong> tab to see
            the results matrix.
          </p>

          <div id="results-table-wrapper" class="table-wrapper" style="display:none;">
            <table class="data-table results-table" id="results-table">
              <!-- Filled by app.js -->
            </table>
          </div>

          <p class="text-muted">
            All indicators are calculated per hectare and relative to the chosen control.
            NPV, PV benefits and PV costs are discounted using the specified rate and time horizon.
          </p>
        </div>
      </section>

      <!-- TAB 4: AI HELPER -->
      <section id="tab-ai" class="tab-pane">
        <div class="card">
          <h2>Step 4: AI helper prompt</h2>
          <p>
            The text below is a ready-made prompt containing the current scenario and results in
            JSON form. Copy and paste it into your preferred AI assistant to generate a
            farmer-friendly interpretation of the CBA.
          </p>

          <div class="ai-actions">
            <button id="btn-copy-prompt" class="btn-primary">Copy prompt to clipboard</button>
            <span id="copy-status" class="text-muted"></span>
          </div>

          <textarea id="ai-prompt" class="ai-textarea" rows="20" spellcheck="false">
Upload your dataset and configure the scenario to generate an AI interpretation prompt.
          </textarea>
        </div>
      </section>

      <!-- TAB 5: EXPORT -->
      <section id="tab-export" class="tab-pane">
        <div class="card">
          <h2>Step 5: Export &amp; print</h2>
          <p>
            Use these options to move the results into your reporting workflow.
          </p>

          <div class="export-buttons">
            <button id="btn-export-excel" class="btn-primary">
              Export results matrix to Excel
            </button>
            <button id="btn-print" class="btn-secondary">
              Print / Save results page as PDF
            </button>
          </div>

          <p class="text-muted">
            The Excel export contains the same vertical results matrix you see in the
            <strong>Results matrix</strong> tab. For a PDF, the
            <strong>Print / Save as PDF</strong> button opens the browser’s print dialog; choose
            “Save as PDF” to create a clean, print-ready file focused on the current tab.
          </p>
        </div>
      </section>
    </main>
  </div>

  <script src="app.js"></script>
</body>
</html>
