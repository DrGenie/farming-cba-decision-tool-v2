<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Faba Beans Trial CBA Decision Aid – Newcastle Business School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <meta name="description" content="Control-centric farm cost–benefit analysis tool for faba bean trials with replicate-specific baselines, discounted CBA, sensitivity analysis, exports and AI briefing." />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body data-theme="worldbank-light">
  <div id="appRoot">
    <!-- Toasts (live region) -->
    <div id="toastRegion" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <header class="app-header">
      <div class="app-header-main">
        <div>
          <h1>Faba Beans Trial CBA Decision Aid</h1>
          <p>Control-centric cost–benefit analysis using plot-level yield and cost data, with replicate-specific baselines.</p>
        </div>
        <div class="app-header-meta">
          <span class="badge badge-brand">Prototype · NBS</span>
          <span class="badge badge-pill">Farm CBA</span>
        </div>
      </div>
      <div class="app-header-secondary">
        <div class="header-kpi">
          <span class="kpi-label">Current dataset</span>
          <span class="kpi-value" id="datasetSummaryLabel">No data loaded</span>
        </div>
        <div class="header-kpi">
          <span class="kpi-label">Control treatment</span>
          <span class="kpi-value" id="controlSummaryLabel">Not detected</span>
        </div>
        <div class="header-kpi">
          <span class="kpi-label">Ranking rule</span>
          <span class="kpi-value">Highest NPV per ha</span>
        </div>
      </div>
    </header>

    <nav class="tab-nav" aria-label="Main sections">
      <button class="tab-button active" data-tab="tabIntro">Intro</button>
      <button class="tab-button" data-tab="tabData">Data &amp; Checks</button>
      <button class="tab-button" data-tab="tabConfig">CBA Settings</button>
      <button class="tab-button" data-tab="tabResults">Results</button>
      <button class="tab-button" data-tab="tabSensitivity">Sensitivity</button>
      <button class="tab-button" data-tab="tabExports">Exports</button>
      <button class="tab-button" data-tab="tabAI">AI Briefing</button>
      <button class="tab-button" data-tab="tabTechnical">Technical appendix</button>
    </nav>

    <main class="tab-panels">
      <!-- Intro -->
      <section id="tabIntro" class="tab-panel active" aria-label="Introduction">
        <div class="card">
          <h2>How to use this tool</h2>
          <p>
            This tool takes plot-level trial data for faba beans, identifies control plots in each replicate, and
            builds a control-centric cost–benefit comparison for all treatments. All calculations are done per hectare.
          </p>
          <ol class="step-list">
            <li>Go to <strong>Data &amp; Checks</strong> to load the faba beans trial dataset (TSV or CSV) or paste the table.</li>
            <li>Review the automatic column mapping, replicate coverage, and data checks.</li>
            <li>In <strong>CBA Settings</strong> define price per tonne, horizon, and discount rate.</li>
            <li>In <strong>Results</strong> inspect the leaderboard and the comparison to control table, including NPV, BCR, ROI, and deltas.</li>
            <li>Use <strong>Sensitivity</strong> to explore how results change with price and discount rate.</li>
            <li>Use <strong>Exports</strong> to download cleaned data and results tables.</li>
            <li>Use <strong>AI Briefing</strong> to copy a ready-to-paste narrative prompt for policy or extension briefs.</li>
          </ol>
        </div>
        <div class="card">
          <h2>Current status</h2>
          <div class="status-grid">
            <div>
              <span class="status-label">Rows loaded</span>
              <span class="status-value" id="statusRowsLoaded">0</span>
            </div>
            <div>
              <span class="status-label">Treatments</span>
              <span class="status-value" id="statusTreatments">0</span>
            </div>
            <div>
              <span class="status-label">Replicates</span>
              <span class="status-value" id="statusReplicates">0</span>
            </div>
            <div>
              <span class="status-label">Controls found</span>
              <span class="status-value" id="statusControlsFound">0</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Data & Checks -->
      <section id="tabData" class="tab-panel" aria-label="Data and checks">
        <div class="panel-two-column">
          <div class="card">
            <h2>Load trial dataset</h2>
            <p class="muted">
              Upload the full faba beans trial dataset (TSV, CSV, or TXT with tabs), or paste it in the textbox. The parser
              will auto-detect delimiters and map columns such as replicates, treatment name, control flag, yield, and costs.
            </p>
            <div class="field-group">
              <label for="fileInput">Upload file</label>
              <input id="fileInput" type="file" accept=".tsv,.csv,.txt,.TXT,.TSV,.CSV" />
            </div>
            <div class="field-group">
              <label for="pasteInput">Paste table (tab-delimited or comma-separated)</label>
              <textarea id="pasteInput" rows="8" placeholder="Paste the full table here (include header row)…"></textarea>
            </div>
            <div class="button-row">
              <button id="btnLoadFile" class="btn primary">Load file</button>
              <button id="btnLoadPaste" class="btn">Load pasted text</button>
              <button id="btnClearData" class="btn subtle">Clear data</button>
            </div>
            <p class="muted small">
              Columns are matched using common variants. For this dataset, key columns include
              <code>replicate_id</code>, <code>treatment_name</code>, <code>is_control</code>,
              <code>yield_t_ha</code>, <code>total_cost_per_ha_raw</code>, and
              <code>cost_amendment_input_per_ha_raw</code>.
            </p>
          </div>

          <div class="card">
            <h2>Column mapping</h2>
            <table class="simple-table" id="mappingSummary">
              <thead>
                <tr>
                  <th>Purpose</th>
                  <th>Column used</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Replicate</td><td class="muted">Not detected</td></tr>
                <tr><td>Treatment name</td><td class="muted">Not detected</td></tr>
                <tr><td>Control flag</td><td class="muted">Not detected</td></tr>
                <tr><td>Yield (t/ha)</td><td class="muted">Not detected</td></tr>
                <tr><td>Variable cost (per ha)</td><td class="muted">Not detected</td></tr>
                <tr><td>Capital cost (per ha, year 0)</td><td class="muted">Not detected</td></tr>
              </tbody>
            </table>

            <h3>Data checks</h3>
            <ul id="dataChecksList" class="checklist"></ul>
          </div>
        </div>

        <div class="card">
          <h2>Preview (first 10 rows)</h2>
          <div class="table-scroll">
            <table class="simple-table" id="dataPreviewTable">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CBA Settings -->
      <section id="tabConfig" class="tab-panel" aria-label="CBA settings">
        <div class="card">
          <h2>Economic assumptions (per hectare)</h2>
          <div class="config-grid">
            <div class="field-group">
              <label for="pricePerTonneInput">Price per tonne of grain</label>
              <div class="input-addon">
                <span class="addon">$</span>
                <input id="pricePerTonneInput" type="number" min="0" step="1" value="400" />
              </div>
              <p class="muted small">Applied to mean yield per treatment. Benefits are assumed constant over the horizon.</p>
            </div>
            <div class="field-group">
              <label for="horizonYearsInput">Time horizon (years)</label>
              <input id="horizonYearsInput" type="number" min="1" step="1" value="10" />
              <p class="muted small">Number of years over which yield and variable costs repeat.</p>
            </div>
            <div class="field-group">
              <label for="discountRateInput">Discount rate (annual, %)</label>
              <input id="discountRateInput" type="number" min="0" max="100" step="0.1" value="4" />
              <p class="muted small">Used to discount yearly benefits and variable costs. Capital costs are treated as year 0.</p>
            </div>
          </div>

          <h3>Interpretation rules</h3>
          <p class="muted">
            For each treatment, the tool computes the mean yield, mean variable cost, and mean capital cost across replicates.
            It then calculates present values of benefits and costs, net present value, benefit–cost ratio, and return on investment.
            Controls are identified using the <code>is_control</code> flag and are used as replicate-specific baselines.
          </p>

          <div class="button-row">
            <button id="btnApplyConfig" class="btn primary">Apply settings</button>
          </div>
        </div>
      </section>

      <!-- Results -->
      <section id="tabResults" class="tab-panel" aria-label="Results">
        <div class="card">
          <h2>Treatment leaderboard (per ha)</h2>
          <p class="muted small">
            Ranked by net present value per hectare. Control treatments are labelled. Values reflect current CBA settings.
          </p>
          <div class="table-scroll">
            <table class="simple-table" id="leaderboardTable">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>Comparison to control</h2>
          <p class="muted small">
            Economic indicators are rows. Columns show the control baseline and all treatments. The table also reports
            changes in NPV and PV costs relative to the control.
          </p>
          <div class="results-filters">
            <button class="btn small" data-results-filter="all">Show all</button>
            <button class="btn small" data-results-filter="top5">Top 5 by NPV</button>
            <button class="btn small" data-results-filter="bcr">Top 5 by BCR</button>
            <button class="btn small" data-results-filter="better">Only improvements vs control</button>
          </div>
          <div class="comparison-scroll">
            <table class="comparison-table" id="comparisonTable">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>Visual summary</h2>
          <p class="muted small">
            Net present value, PV benefits, and PV costs per hectare for each treatment (current filter subset).
          </p>
          <div class="chart-wrapper">
            <canvas id="resultsChart" aria-label="NPV and PV breakdown by treatment"></canvas>
          </div>
        </div>
      </section>

      <!-- Sensitivity -->
      <section id="tabSensitivity" class="tab-panel" aria-label="Sensitivity analysis">
        <div class="card">
          <h2>Simple sensitivity grid</h2>
          <p class="muted small">
            Explore how rankings change when grain price and discount rate vary. The tool evaluates several
            price and discount scenarios around the current central values.
          </p>
          <div class="config-grid">
            <div class="field-group">
              <label for="sensPriceStepInput">Price step (per tonne)</label>
              <div class="input-addon">
                <span class="addon">$</span>
                <input id="sensPriceStepInput" type="number" min="1" step="1" value="50" />
              </div>
            </div>
            <div class="field-group">
              <label for="sensRateStepInput">Discount rate step (percentage points)</label>
              <input id="sensRateStepInput" type="number" min="0.1" step="0.1" value="1" />
            </div>
          </div>
          <div class="button-row">
            <button id="btnRunSensitivity" class="btn primary">Run sensitivity grid</button>
          </div>
        </div>

        <div class="card">
          <h2>Top treatment across scenarios</h2>
          <div class="table-scroll">
            <table class="simple-table" id="sensitivityTable">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Exports -->
      <section id="tabExports" class="tab-panel" aria-label="Exports">
        <div class="card">
          <h2>Download tables</h2>
          <p class="muted small">
            Export cleaned input data and results tables for further analysis in Excel, R, Stata, or other tools.
          </p>
          <div class="button-row">
            <button id="btnExportCleanTsv" class="btn">Download cleaned dataset (TSV)</button>
            <button id="btnExportSummaryCsv" class="btn">Download treatment summary (CSV)</button>
            <button id="btnExportComparisonCsv" class="btn">Download comparison to control (CSV)</button>
          </div>
        </div>

        <div class="card">
          <h2>Quick copy blocks</h2>
          <div class="field-group">
            <label for="jsonResultsTextarea">Results JSON (for downstream tools)</label>
            <textarea id="jsonResultsTextarea" rows="10" spellcheck="false"></textarea>
          </div>
          <div class="button-row">
            <button id="btnCopyResultsJson" class="btn">Copy JSON</button>
          </div>
        </div>
      </section>

      <!-- AI Briefing -->
      <section id="tabAI" class="tab-panel" aria-label="AI briefing">
        <div class="card">
          <h2>AI briefing prompt</h2>
          <p class="muted small">
            This text is designed to be pasted directly into an AI assistant. It explains the scenario and embeds
            a structured JSON of the results. No bullet points are used.
          </p>
          <div class="field-group">
            <label for="aiBriefingTextarea">Briefing text</label>
            <textarea id="aiBriefingTextarea" rows="16" spellcheck="false"></textarea>
          </div>
          <div class="button-row">
            <button id="btnCopyAiBriefing" class="btn primary">Copy briefing text</button>
          </div>
        </div>
      </section>

      <!-- Technical appendix -->
      <section id="tabTechnical" class="tab-panel" aria-label="Technical appendix">
        <div class="card">
          <h2>Technical appendix</h2>
          <p class="muted">
            This prototype applies a simple partial budget logic to plot-level data. Key design choices:
          </p>
          <ul class="tech-list">
            <li>Replicates are identified using the <code>replicate_id</code> column.</li>
            <li>Controls are identified by the <code>is_control</code> column and can vary by replicate.</li>
            <li>Yield is taken from <code>yield_t_ha</code>.</li>
            <li>Raw total cost per hectare is taken from <code>total_cost_per_ha_raw</code>.</li>
            <li>Amendment input cost per hectare is taken from <code>cost_amendment_input_per_ha_raw</code>.</li>
            <li>Variable cost per hectare is calculated as total cost minus amendment cost where possible.</li>
            <li>Capital cost per hectare is taken as the amendment input cost where available and non-negative.</li>
            <li>Yearly benefits and variable costs repeat over the time horizon; capital costs occur at year 0.</li>
          </ul>
          <p class="muted small">
            For a full external appendix, link this tab to a separate PDF or HTML page using the same indicators
            and formulas implemented in the JavaScript code.
          </p>
          <a href="technical-appendix.html" target="_blank" rel="noopener" class="btn subtle">Open external technical appendix</a>
        </div>
      </section>
    </main>
  </div>

  <script src="app.js"></script>
</body>
</html>
